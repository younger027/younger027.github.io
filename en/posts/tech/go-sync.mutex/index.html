<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go sync.mutexæºç è§£æ | Younger&#39;s Blog</title>
<meta name="keywords" content="golang, æºç ">
<meta name="description" content="å¼€ç«¯ ä»Šå¤©å­¦ä¹ ä¸‹goé‡Œé¢çš„sync.mutexçš„å®ç°ä»¥åŠç›¸å…³æ‰©å±•çŸ¥è¯†ã€‚ é”çš„ä»‹ç» é¦–å…ˆï¼Œè®¡ç®—æœºä¸­çš„é”æ˜¯ä¸ºäº†æ§åˆ¶å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€èµ„æºçš„å¹¶å‘è®¿é—®ã€‚é”">
<meta name="author" content="Younger">
<link rel="canonical" href="https://younger027.github.io/en/posts/tech/go-sync.mutex/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="apple-touch-icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="mask-icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Go sync.mutexæºç è§£æ" />
<meta property="og:description" content="å¼€ç«¯ ä»Šå¤©å­¦ä¹ ä¸‹goé‡Œé¢çš„sync.mutexçš„å®ç°ä»¥åŠç›¸å…³æ‰©å±•çŸ¥è¯†ã€‚ é”çš„ä»‹ç» é¦–å…ˆï¼Œè®¡ç®—æœºä¸­çš„é”æ˜¯ä¸ºäº†æ§åˆ¶å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€èµ„æºçš„å¹¶å‘è®¿é—®ã€‚é”" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://younger027.github.io/en/posts/tech/go-sync.mutex/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-02T17:13:40+08:00" />
<meta property="article:modified_time" content="2023-02-02T17:13:40+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go sync.mutexæºç è§£æ"/>
<meta name="twitter:description" content="å¼€ç«¯ ä»Šå¤©å­¦ä¹ ä¸‹goé‡Œé¢çš„sync.mutexçš„å®ç°ä»¥åŠç›¸å…³æ‰©å±•çŸ¥è¯†ã€‚ é”çš„ä»‹ç» é¦–å…ˆï¼Œè®¡ç®—æœºä¸­çš„é”æ˜¯ä¸ºäº†æ§åˆ¶å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€èµ„æºçš„å¹¶å‘è®¿é—®ã€‚é”"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://younger027.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://younger027.github.io/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Go sync.mutexæºç è§£æ",
      "item": "https://younger027.github.io/en/posts/tech/go-sync.mutex/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go sync.mutexæºç è§£æ",
  "name": "Go sync.mutexæºç è§£æ",
  "description": "å¼€ç«¯ ä»Šå¤©å­¦ä¹ ä¸‹goé‡Œé¢çš„sync.mutexçš„å®ç°ä»¥åŠç›¸å…³æ‰©å±•çŸ¥è¯†ã€‚ é”çš„ä»‹ç» é¦–å…ˆï¼Œè®¡ç®—æœºä¸­çš„é”æ˜¯ä¸ºäº†æ§åˆ¶å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€èµ„æºçš„å¹¶å‘è®¿é—®ã€‚é”",
  "keywords": [
    "golang", "æºç "
  ],
  "articleBody": " å¼€ç«¯ ä»Šå¤©å­¦ä¹ ä¸‹goé‡Œé¢çš„sync.mutexçš„å®ç°ä»¥åŠç›¸å…³æ‰©å±•çŸ¥è¯†ã€‚\né”çš„ä»‹ç» é¦–å…ˆï¼Œè®¡ç®—æœºä¸­çš„é”æ˜¯ä¸ºäº†æ§åˆ¶å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€èµ„æºçš„å¹¶å‘è®¿é—®ã€‚é”å‘¢ï¼Œæœ‰åˆ©æœ‰å¼Šã€‚å¥½çš„ç‚¹åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å¹¶å‘è®¿é—®çš„é¡ºåºé€»è¾‘ã€‚é¿å…ç¨‹åºå› ä¸ºèµ„æºç«äº‰ï¼Œè€Œå‡ºç°ä¸€äº›é¢„æœŸå¤–çš„æƒ…å†µã€‚ ä¸å¥½çš„ç‚¹åœ¨äºï¼ŒåŠ é”æ„å‘³ç€å¹¶å‘åº¦çš„ä¸‹é™ï¼Œæ•ˆç‡çš„ä¸‹é™ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨é”æ¥å®Œæˆä¸šåŠ¡éœ€æ±‚çš„æ—¶å€™ï¼Œä¹Ÿè¦è€ƒè™‘é”ç«äº‰å¯¹ä¸šåŠ¡å¸¦æ¥çš„å½±å“ã€‚æ ¹æ®ä¸šåŠ¡æƒ…å†µç¡®å®šæ˜¯å¦ä½¿ç”¨åŠä½¿ç”¨çš„æ–¹å¼ã€‚\næ•°æ®ç»“æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // A Mutex is a mutual exclusion lock. // The zero Val for a Mutex is an unlocked mutex. // // A Mutex must not be copied after first use. type Mutex struct { state int32 sema uint32 } // A Locker represents an object that can be locked and unlocked. type Locker interface { Lock() Unlock() } const ( mutexLocked = 1 \u003c\u003c iota // mutex is locked mutexWoken mutexStarving mutexWaiterShift = iota // Mutex fairness. // // Mutex can be in 2 modes of operations: normal and starvation. // In normal mode waiters are queued in FIFO order, but a woken up waiter // does not own the mutex and competes with new arriving goroutines over // the ownership. New arriving goroutines have an advantage -- they are // already running on CPU and there can be lots of them, so a woken up // waiter has good chances of losing. In such case it is queued at front // of the wait queue. If a waiter fails to acquire the mutex for more than 1ms, // it switches mutex to the starvation mode. // // In starvation mode ownership of the mutex is directly handed off from // the unlocking goroutine to the waiter at the front of the queue. // New arriving goroutines don't try to acquire the mutex even if it appears // to be unlocked, and don't try to spin. Instead they queue themselves at // the tail of the wait queue. // // If a waiter receives ownership of the mutex and sees that either // (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms, // it switches mutex back to normal operation mode. // // Normal mode has considerably better performance as a goroutine can acquire // a mutex several times in a row even if there are blocked waiters. // Starvation mode is important to prevent pathological cases of tail latency. starvationThresholdNs = 1e6 ) ä¸Šé¢ä»£ç å°±æ˜¯go1.18ä¸­sync.mutexçš„å®šä¹‰ã€‚å¯ä»¥çœ‹åˆ°Mutexç»“æ„ä½“ä¸­æœ‰stateå’Œsemaä¸¤ä¸ªå­—æ®µï¼Œ\nstate int32ç±»å‹ï¼Œä»£è¡¨çš„æ˜¯é”çš„çŠ¶æ€. sema uint32ç±»å‹ï¼Œä»£è¡¨ä¿¡å·é‡ã€‚ä»–ä¸»è¦ç”¨äºå”¤é†’é˜»å¡åœ¨äº’æ–¥é”ä¸Šçš„å…¶ä»–åç¨‹ã€‚ é”çš„çŠ¶æ€ å›¾ç‰‡æ¥è‡ªDravenesså¤§ç¥ï¼Œstateæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š\nmutexLockedã€‚é”çŠ¶æ€ï¼Œå 1bitï¼Œ0-å¯ä»¥è·å–é”ï¼Œ1-é”å®šçŠ¶æ€ï¼Œé˜»å¡ç­‰å¾… mutexWokenã€‚å”¤é†’çŠ¶æ€ã€‚å 1bitï¼Œä»£è¡¨ä¸€ä¸ªè¿‡ç¨‹é˜¶æ®µï¼Œ0-æ²¡æœ‰åç¨‹å”¤é†’ 1-æœ‰åç¨‹è¢«å”¤é†’ï¼Œç”³è¯·é”å®šè¿‡ç¨‹ä¸­ã€‚ mutexStarvingã€‚é¥¥é¥¿çŠ¶æ€ã€‚å 1bitï¼Œå½“åç¨‹è¶…è¿‡1msè¿˜æ²¡æœ‰è·å–é”æ—¶ï¼Œé”å°±ä¼šå¤„äºé¥¥é¥¿çŠ¶æ€ã€‚ mutexWaiterShift/waitersCountã€‚ç­‰å¾…ä¿¡å·é‡çŠ¶æ€ã€‚å 29bitï¼Œå½“æœ‰åç¨‹é‡Šæ”¾é”æ—¶ï¼Œéœ€è¦æ ¹æ®æ­¤çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦é‡Šæ”¾ä¿¡å·é‡ã€‚ç”¨äºé€šçŸ¥å…¶ä»–åç¨‹è·å–æ­¤é”ã€‚ å®ç°åŸç† sync.Mutexçš„å®ç°ä»£ç åªæœ‰200å¤šè¡Œï¼Œä½†æ˜¯é‡Œé¢é”çš„åˆ‡æ¢æ§åˆ¶è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œä¸‹é¢æˆ‘ä»¬é€æ­¥æ¥åˆ†æ\nåŠ é”è¿‡ç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Lock locks m. // If the lock is already in use, the calling goroutine // blocks until the mutex is available. func (m *Mutex) Lock() { // Fast path: grab unlocked mutex. if atomic.CompareAndSwapInt32(\u0026m.state, 0, mutexLocked) { if race.Enabled { race.Acquire(unsafe.Pointer(m)) } return } // Slow path (outlined so that the fast path can be inlined) m.lockSlow() } Lockå‡½æ•°ä½¿ç”¨CompareAndSwapInt32åˆ¤æ–­m.stateæ˜¯ä¸æ˜¯0ï¼Œå¦‚æœæ˜¯çš„è¯stateè®¾ä¸ºlockçŠ¶æ€ï¼ŒæˆåŠŸè·å–åˆ°é”ã€‚ å¤±è´¥åˆ™è°ƒç”¨lockSlow()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å®ç°çŠ¶æ€æ§åˆ¶çš„ä¸»è¦é€»è¾‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 func (m *Mutex) lockSlow() { var waitStartTime int64 starving := false awoke := false iter := 0 old := m.state for { // Don't spin in starvation mode, ownership is handed off to waiters // so we won't be able to acquire the mutex anyway. if old\u0026(mutexLocked|mutexStarving) == mutexLocked \u0026\u0026 runtime_canSpin(iter) { // Active spinning makes sense. // Try to set mutexWoken flag to inform Unlock // to not wake other blocked goroutines. if !awoke \u0026\u0026 old\u0026mutexWoken == 0 \u0026\u0026 old\u003e\u003emutexWaiterShift != 0 \u0026\u0026 atomic.CompareAndSwapInt32(\u0026m.state, old, old|mutexWoken) { awoke = true } runtime_doSpin() iter++ old = m.state continue } new := old // Don't try to acquire starving mutex, new arriving goroutines must queue. if old\u0026mutexStarving == 0 { new |= mutexLocked } if old\u0026(mutexLocked|mutexStarving) != 0 { new += 1 \u003c\u003c mutexWaiterShift } // The current goroutine switches mutex to starvation mode. // But if the mutex is currently unlocked, don't do the switch. // Unlock expects that starving mutex has waiters, which will not // be true in this case. if starving \u0026\u0026 old\u0026mutexLocked != 0 { new |= mutexStarving } if awoke { // The goroutine has been woken from sleep, // so we need to reset the flag in either case. if new\u0026mutexWoken == 0 { throw(\"sync: inconsistent mutex state\") } new \u0026^= mutexWoken } if atomic.CompareAndSwapInt32(\u0026m.state, old, new) { if old\u0026(mutexLocked|mutexStarving) == 0 { break // locked the mutex with CAS } // If we were already waiting before, queue at the front of the queue. queueLifo := waitStartTime != 0 if waitStartTime == 0 { waitStartTime = runtime_nanotime() } runtime_SemacquireMutex(\u0026m.sema, queueLifo, 1) starving = starving || runtime_nanotime()-waitStartTime \u003e starvationThresholdNs old = m.state if old\u0026mutexStarving != 0 { // If this goroutine was woken and mutex is in starvation mode, // ownership was handed off to us but mutex is in somewhat // inconsistent state: mutexLocked is not set and we are still // accounted as waiter. Fix that. if old\u0026(mutexLocked|mutexWoken) != 0 || old\u003e\u003emutexWaiterShift == 0 { throw(\"sync: inconsistent mutex state\") } delta := int32(mutexLocked - 1\u003c\u003cmutexWaiterShift) if !starving || old\u003e\u003emutexWaiterShift == 1 { // Exit starvation mode. // Critical to do it here and consider wait time. // Starvation mode is so inefficient, that two goroutines // can go lock-step infinitely once they switch mutex // to starvation mode. delta -= mutexStarving } atomic.AddInt32(\u0026m.state, delta) break } awoke = true iter = 0 } else { old = m.state } } if race.Enabled { race.Acquire(unsafe.Pointer(m)) } } slowLockå‡½æ•°ä¾é CAS+ä¿¡å·é‡+è‡ªæ—‹æ¥å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹ç…§ä»£ç ï¼Œé€è¡Œåˆ†æä¸‹é€»è¾‘ï¼š\n1.åœ¨è°ƒç”¨slowLockä¹‹å‰ï¼Œå·²ç»åˆ¤æ–­è¿‡stateæ˜¯å¦å¯ä»¥è·å–é”ã€‚è¿›å…¥slowLockåä¼šé˜»å¡å½“å‰Gï¼Œå°è¯•è·å–é”ã€‚ é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼š ã€é”å¤„äºéé¥¥é¥¿çŠ¶æ€, lockedçŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥è‡ªæ—‹ã€‘ï¼Œæ»¡è¶³å³å¼€å§‹è‡ªæ—‹ï¼Œåœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­å°è¯•å°†é”çš„çŠ¶æ€è®¾ç½®ä¸ºå”¤é†’ï¼Œå°½é‡è®©å½“å‰Gè·å–çš„é”ã€‚\n2.å½“åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­å‘ç°å¯ä»¥è·å–é”æ—¶ï¼Œè¿›å…¥ä¸‹é¢é€»è¾‘ã€‚ç”¨oldåˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶çš„new stateã€‚åˆ¤æ–­é”å¦‚æœä¸å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œnew stateåŠ ä¸ŠlockedçŠ¶æ€ã€‚ (é¥¥é¥¿çŠ¶æ€ä¸‹çš„é”ï¼ŒGæ˜¯éœ€è¦æ’é˜Ÿæ‰å¯ä»¥è·å–çš„ï¼Œæºç æ³¨é‡Šä¹Ÿæœ‰)ã€‚æ¥ç€ï¼Œåˆ¤æ–­oldçŠ¶æ€æ˜¯lockedæˆ–è€…é¥¥é¥¿æ—¶ï¼Œå°†waiterShiftåŠ 8ï¼Œä»£è¡¨ç­‰å¾…çš„GåŠ 1ã€‚ æ¥ç€åˆ¤æ–­å¦‚æœæ­¤Gå·²ç»å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œå¹¶ä¸”oldå·²ç»å¤„äºlockedçŠ¶æ€ã€‚new stateå°±å¢åŠ é¥¥é¥¿çŠ¶æ€ã€‚(æ–‡ä¸­çš„ç¿»è¯‘è¯´æ˜äº†åŸå› ï¼Œå½“å‰çš„goroutineå°†mutexè®¾ä¸ºé¥¥é¥¿çŠ¶æ€ï¼Œ ä½†æ˜¯å¦‚æœmutexå·²ç»è§£é”çš„è¯ï¼Œå°±ä¸è¦è¿›è¡Œè®¾å®šäº†ã€‚å› ä¸ºUnlockéœ€è¦å¤„äºé¥¥é¥¿çŠ¶æ€çš„mutexæœ‰ç­‰å¾…è€…)ã€‚ åˆ¤æ–­å½“å‰Gæ˜¯å¦æ˜¯è¢«å”¤é†’çš„ï¼Œæ˜¯çš„è¯å°†new stateè®¾ç½®æˆéå”¤é†’ã€‚\n3.æ¥ä¸‹æ¥è¦æ³¨æ„ï¼Œè¿™é‡Œå†æ¬¡å°†m.stateå’Œoldè¿›è¡Œäº†æ¯”è¾ƒã€‚ä¸»è¦æ˜¯åˆ¤æ–­æœ‰å…¶ä»–çš„goroutineæ”¹å˜mutexçš„çŠ¶æ€ã€‚å¦‚æœæœ‰çš„è¯new stateå°±ä½œåºŸï¼Œå®Œæˆæœ¬æ¬¡é€»è¾‘ï¼Œç»§ç»­å¾ªç¯è‡ªæ—‹å°è¯•è·å–é”ã€‚ å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå½“å‰æ— é”+ä¸é¥¥é¥¿å°±å¯ä»¥è·å–é”æˆåŠŸbreakã€‚å¦åˆ™åŠ é”å¤±è´¥ï¼ŒGéœ€è¦è¿›å…¥é˜Ÿåˆ—ï¼Œå¦‚æœGç¬¬ä¸€æ¬¡ç­‰å¾…å°±æ”¾åœ¨é˜Ÿå°¾ï¼Œå¦åˆ™å°±æ˜¯è¢«å”¤é†’å†æ¬¡è·å–é”å¤±è´¥ã€‚å°±ä¼šè¢«æ”¾åœ¨é˜Ÿé¦–ã€‚ åˆ¤æ–­å½“å‰Gæ˜¯å¦è¯¥è¿›å…¥é¥¥é¥¿çŠ¶æ€çš„æ ‡å‡†æ˜¯Gç­‰å¾…mutexçš„æ—¶é—´æ˜¯å¦å¤§äº1msã€‚é‡æ–°è·å–mutexçš„çŠ¶æ€ï¼Œå¦‚æœå¤„äºé¥¥é¥¿çŠ¶æ€è·å–é”æˆåŠŸã€‚æ­¤æ—¶éœ€è¦è€ƒè™‘è§£é™¤é”çš„é¥¥é¥¿çŠ¶æ€ã€‚ æ»¡è¶³1.å½“å‰Gç­‰å¾…æ—¶é—´å°äº1ms 2.ç­‰å¾…é˜Ÿåˆ—ä¸ºç©º ä¸¤ä¸ªæ¡ä»¶å…¶ä¸€å³å¯é€€å‡ºé¥¥é¥¿æ¨¡å¼ã€‚\nä¸Šé¢æ˜¯å¯¹ç…§ä»£ç çš„ç†è§£è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬æ€»ç»“ä¸‹ï¼š æ­£å¸¸æƒ…å†µä¸‹, å½“ä¸€ä¸ªGoroutineè·å–åˆ°é”å, å…¶ä»–çš„Gè·å–é”æ—¶ä¼šè‡ªæ—‹æˆ–è€…è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…ä¿¡å·é‡å”¤é†’ï¼Œè‡ªæ—‹æ˜¯å¸Œæœ›å½“å‰çš„Gèƒ½è·å–åˆ°é”ï¼Œå› ä¸ºå®ƒæŒæœ‰CPUï¼Œ å¯ä»¥é¿å…èµ„æºåˆ‡æ¢ã€‚ä½†æ˜¯åˆä¸èƒ½ä¸€ç›´è‡ªæ—‹ï¼Œ æ‰€ä»¥mutexå°±ä¼šæœ‰é¥¥é¥¿æ¨¡å¼ï¼Œå¦‚æœä¸€ä¸ªGè¢«å”¤é†’è¿‡å, ä»ç„¶æ²¡æœ‰æ‹¿åˆ°é”, é‚£ä¹ˆè¯¥Gä¼šæ”¾åœ¨ç­‰å¾…é˜Ÿåˆ—çš„æœ€å‰é¢ã€‚ å¹¶ä¸”é‚£äº›ç­‰å¾…è¶…è¿‡1msçš„Gè¿˜æ²¡æœ‰è·å–åˆ°é”ï¼Œè¯¥Gå°±ä¼šè¿›å…¥é¥¥é¥¿çŠ¶æ€ã€‚è¯¥Gæ˜¯é¥¥é¥¿çŠ¶æ€å¹¶ä¸”Mutexæ˜¯LockedçŠ¶æ€æ—¶ï¼Œæ‰æœ‰å¯èƒ½ç»™Mutexè®¾ç½®æˆé¥¥é¥¿çŠ¶æ€ã€‚\nè·å–åˆ°é”çš„Gè§£é”æ—¶ï¼Œå°†mutexçš„çŠ¶æ€è®¾ä¸ºunlockï¼Œç„¶åå‘å‡ºä¿¡å·ï¼Œç­‰å¾…çš„Gå¼€å§‹æŠ¢å¤ºé”çš„ã€‚ä½†æ˜¯å¦‚æœmutexå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œå°±ä¼šå°†ä¿¡å·å‘ç»™ç¬¬ä¸€ä¸ªGï¼Œå”¤é†’å®ƒã€‚è¿™å°±æ˜¯Gæ’é˜Ÿã€‚\nè§£é”è¿‡ç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // Unlock unlocks m. // It is a run-time error if m is not locked on entry to Unlock. // // A locked Mutex is not associated with a particular goroutine. // It is allowed for one goroutine to lock a Mutex and then // arrange for another goroutine to unlock it. func (m *Mutex) Unlock() { if race.Enabled { _ = m.state race.Release(unsafe.Pointer(m)) } // Fast path: drop lock bit. new := atomic.AddInt32(\u0026m.state, -mutexLocked) if new != 0 { // Outlined slow path to allow inlining the fast path. // To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock. m.unlockSlow(new) } } func (m *Mutex) unlockSlow(new int32) { if (new+mutexLocked)\u0026mutexLocked == 0 { throw(\"sync: unlock of unlocked mutex\") } if new\u0026mutexStarving == 0 { old := new for { // If there are no waiters or a goroutine has already // been woken or grabbed the lock, no need to wake anyone. // In starvation mode ownership is directly handed off from unlocking // goroutine to the next waiter. We are not part of this chain, // since we did not observe mutexStarving when we unlocked the mutex above. // So get off the way. if old\u003e\u003emutexWaiterShift == 0 || old\u0026(mutexLocked|mutexWoken|mutexStarving) != 0 { return } // Grab the right to wake someone. new = (old - 1\u003c\u003cmutexWaiterShift) | mutexWoken if atomic.CompareAndSwapInt32(\u0026m.state, old, new) { runtime_Semrelease(\u0026m.sema, false, 1) return } old = m.state } } else { // Starving mode: handoff mutex ownership to the next waiter, and yield // our time slice so that the next waiter can start to run immediately. // Note: mutexLocked is not set, the waiter will set it after wakeup. // But mutex is still considered locked if mutexStarving is set, // so new coming goroutines won't acquire it. runtime_Semrelease(\u0026m.sema, true, 1) } } è§£é™¤mutexçš„lockçŠ¶æ€ï¼Œè·å–åˆ°æœ€æ–°çš„çŠ¶æ€newã€‚å¦‚æœnewæ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå”¤é†’ç¬¬ä¸€ä¸ªGï¼Œè·å–é”ã€‚è§£é”å®Œæˆã€‚ å¦‚æœä¸æ˜¯é¥¥é¥¿çŠ¶æ€ã€‚å½“å‰æ²¡æœ‰Gç­‰å¾…ï¼Œæˆ–è€…æœ‰Gå·²ç»è¢«å”¤é†’å»åŠ é”äº†ã€‚å°±ä¸éœ€è¦åšå”¤é†’çš„åŠ¨ä½œã€‚é€€å‡ºå³å¯ã€‚ å¦åˆ™å°†ç­‰å¾…çš„G-1ï¼Œå¹¶ä¸€ç›´å°è¯•å°†Gè®¾ç½®ä¸ºå”¤é†’çŠ¶æ€ï¼Œé‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥æ‰€æœ‰çš„Géƒ½å¯ä»¥å»æŠ¢å¤ºé”ã€‚è®¾ç½®æˆåŠŸè§£é”å®Œæˆï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œã€‚\nå¼•ç”³é—®é¢˜ æºç é˜…è¯»æ³¨æ„çš„ç‚¹ åœ¨ç†è§£sync.mutexçš„æ—¶å€™ï¼Œä¸€å®šè¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œmçš„stateåœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¾ˆå¯èƒ½ä¼šæœ‰å…¶ä»–çš„Gæ”¹å˜å…¶çŠ¶æ€ã€‚æ‰€ä»¥æŸ¥çœ‹ä»£ç é€»è¾‘çš„æ—¶å€™ï¼Œ ä¸€å®šè¦æ—¶åˆ»è®°å¾—è¿™ä¸ªç‚¹\nwokençŠ¶æ€çš„æ„ä¹‰ WokençŠ¶æ€ç”¨äºåŠ é”å’Œè§£é”è¿‡ç¨‹çš„é€šä¿¡ï¼Œä¸¾ä¸ªä¾‹å­ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œä¸¤ä¸ªåç¨‹ä¸€ä¸ªåœ¨åŠ é”ï¼Œä¸€ä¸ªåœ¨è§£é”ï¼Œåœ¨åŠ é”çš„åç¨‹å¯èƒ½åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œ æ­¤æ—¶æŠŠWokenæ ‡è®°ä¸º1ï¼Œç”¨äºé€šçŸ¥è§£é”åç¨‹ä¸å¿…é‡Šæ”¾ä¿¡å·é‡äº†ï¼Œå¥½æ¯”åœ¨è¯´ï¼šä½ åªç®¡è§£é”å¥½äº†ï¼Œä¸å¿…é‡Šæ”¾ä¿¡å·é‡ï¼Œæˆ‘é©¬ä¸Šå°±æ‹¿åˆ°é”äº†ã€‚\nä¸ºä»€ä¹ˆé‡å¤è§£é”ä¼španic Unlockçš„é€»è¾‘æ˜¯ï¼Œè§£é™¤mutexçš„lockçŠ¶æ€ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦æœ‰åç¨‹ç­‰å¾…ï¼Œæœ‰çš„è¯é‡Šæ”¾ä¿¡å·é‡ï¼Œå”¤é†’åç¨‹ã€‚å¦‚æœå¤šæ¬¡unlockçš„è¯ï¼Œå°±ä¼š å‘é€å¤šä¸ªä¿¡å·é‡ï¼Œå”¤é†’å¤šä¸ªGå»æŠ¢å¤ºé”ã€‚ä¼šé€ æˆä¸å¿…è¦çš„ç«äº‰ï¼Œä¹Ÿä¼šé€ æˆåç¨‹åˆ‡æ¢ï¼Œæµªè´¹èµ„æºï¼Œå®ç°å¤æ‚åº¦ä¹Ÿä¼šå¢åŠ ã€‚\nGçš„é¥¥é¥¿å’Œmutexé¥¥é¥¿çš„å…³ç³» åªæœ‰Gå¤„äºé¥¥é¥¿çŠ¶æ€çš„æ—¶å€™ï¼Œæ‰ä¼šå°†mutexè®¾ä¸ºé¥¥é¥¿çŠ¶æ€ã€‚å½“mutexå¤„äºé¥¥é¥¿çŠ¶æ€æ—¶ï¼Œæ‰å¯èƒ½ä¼šè®©é¥¥é¥¿çš„Gè·å–åˆ°é”ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®¾mutex ä¸ºé¥¥é¥¿çŠ¶æ€çš„Gä¸ä¸€å®šä¼šè·å–åˆ°é”ï¼Œæœ‰å¯èƒ½ä¼šè¢«å…¶ä»–Gæˆªèƒ¡ã€‚\nGå¯ä»¥æˆåŠŸè·å–é”çš„æƒ…å†µ ç¬¬ä¸€æ¬¡åŠ é”çš„æ—¶å€™m.state=0ï¼Œä¸€å®šæ˜¯å¯ä»¥è·å–é”ã€‚æ²¡æœ‰å…¶ä»–çš„Gè·å–é”ï¼Œæ²¡æœ‰æ”¹å˜å…¶çŠ¶æ€ã€‚ å½“å‰çš„mutexä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯lockçŠ¶æ€ï¼Œå°è¯•CASåŠ é”çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–Gæ”¹å˜mçŠ¶æ€ï¼Œå¯ä»¥æˆåŠŸã€‚ æŸä¸ªGè¢«å”¤é†’åï¼Œé‡æ–°è·å–mutexï¼Œæ­¤æ—¶mutexå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œæ²¡æœ‰å…¶ä»–çš„Gæ¥æŠ¢å¤ºï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™åªå”¤é†’äº†é¥¥é¥¿çš„Gï¼ŒGä¹Ÿå¯ä»¥æˆåŠŸã€‚ å‚è€ƒèµ„æ–™ https://blog.csdn.net/baolingye/article/details/111357407 https://blog.csdn.net/qq_37102984/article/details/115322706 https://mp.weixin.qq.com/s/BZvfNn_Vre7o2T8BZ4LLMw ",
  "wordCount" : "3994",
  "inLanguage": "en",
  "datePublished": "2023-02-02T17:13:40+08:00",
  "dateModified": "2023-02-02T17:13:40+08:00",
  "author":[{
    "@type": "Person",
    "name": "Younger"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://younger027.github.io/en/posts/tech/go-sync.mutex/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Younger's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://youngergo.cn/images/life/me/avatar.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://younger027.github.io/en/" accesskey="h" title="Younger&#39;s Blog (Alt + H)">
                <img src="https://youngergo.cn/images/life/me/avatar.jpg" alt="" aria-label="logo"
                    height="35">Younger&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://younger027.github.io/en/">Home</a>&nbsp;Â»&nbsp;<a href="https://younger027.github.io/en/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://younger027.github.io/en/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Go sync.mutexæºç è§£æ
    </h1>
    <div class="post-meta"><span title='2023-02-02 17:13:40 +0800 CST'>2023-02-02</span>&nbsp;Â·&nbsp;8 min&nbsp;Â·&nbsp;Younger

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%bc%80%e7%ab%af" aria-label="å¼€ç«¯">å¼€ç«¯</a></li>
                <li>
                    <a href="#%e9%94%81%e7%9a%84%e4%bb%8b%e7%bb%8d" aria-label="é”çš„ä»‹ç»">é”çš„ä»‹ç»</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</a><ul>
                        
                <li>
                    <a href="#%e9%94%81%e7%9a%84%e7%8a%b6%e6%80%81" aria-label="é”çš„çŠ¶æ€">é”çš„çŠ¶æ€</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86" aria-label="å®ç°åŸç†">å®ç°åŸç†</a><ul>
                        
                <li>
                    <a href="#%e5%8a%a0%e9%94%81%e8%bf%87%e7%a8%8b" aria-label="åŠ é”è¿‡ç¨‹">åŠ é”è¿‡ç¨‹</a></li>
                <li>
                    <a href="#%e8%a7%a3%e9%94%81%e8%bf%87%e7%a8%8b" aria-label="è§£é”è¿‡ç¨‹">è§£é”è¿‡ç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%bc%95%e7%94%b3%e9%97%ae%e9%a2%98" aria-label="å¼•ç”³é—®é¢˜">å¼•ç”³é—®é¢˜</a><ul>
                        
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%e6%b3%a8%e6%84%8f%e7%9a%84%e7%82%b9" aria-label="æºç é˜…è¯»æ³¨æ„çš„ç‚¹">æºç é˜…è¯»æ³¨æ„çš„ç‚¹</a></li>
                <li>
                    <a href="#woken%e7%8a%b6%e6%80%81%e7%9a%84%e6%84%8f%e4%b9%89" aria-label="wokençŠ¶æ€çš„æ„ä¹‰">wokençŠ¶æ€çš„æ„ä¹‰</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%87%8d%e5%a4%8d%e8%a7%a3%e9%94%81%e4%bc%9apanic" aria-label="ä¸ºä»€ä¹ˆé‡å¤è§£é”ä¼španic">ä¸ºä»€ä¹ˆé‡å¤è§£é”ä¼španic</a></li>
                <li>
                    <a href="#g%e7%9a%84%e9%a5%a5%e9%a5%bf%e5%92%8cmutex%e9%a5%a5%e9%a5%bf%e7%9a%84%e5%85%b3%e7%b3%bb" aria-label="Gçš„é¥¥é¥¿å’Œmutexé¥¥é¥¿çš„å…³ç³»">Gçš„é¥¥é¥¿å’Œmutexé¥¥é¥¿çš„å…³ç³»</a></li>
                <li>
                    <a href="#g%e5%8f%af%e4%bb%a5%e6%88%90%e5%8a%9f%e8%8e%b7%e5%8f%96%e9%94%81%e7%9a%84%e6%83%85%e5%86%b5" aria-label="Gå¯ä»¥æˆåŠŸè·å–é”çš„æƒ…å†µ">Gå¯ä»¥æˆåŠŸè·å–é”çš„æƒ…å†µ</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" aria-label="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><img loading="lazy" src="https://youngergo.cn/images/tech/go-sync.mutex/go-sync-mutext.jpg" alt="Lock"  />
</p>
<h3 id="å¼€ç«¯">å¼€ç«¯<a hidden class="anchor" aria-hidden="true" href="#å¼€ç«¯">#</a></h3>
<p>ä»Šå¤©å­¦ä¹ ä¸‹goé‡Œé¢çš„sync.mutexçš„å®ç°ä»¥åŠç›¸å…³æ‰©å±•çŸ¥è¯†ã€‚</p>
<h3 id="é”çš„ä»‹ç»">é”çš„ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#é”çš„ä»‹ç»">#</a></h3>
<p>é¦–å…ˆï¼Œè®¡ç®—æœºä¸­çš„é”æ˜¯ä¸ºäº†æ§åˆ¶å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€èµ„æºçš„å¹¶å‘è®¿é—®ã€‚é”å‘¢ï¼Œæœ‰åˆ©æœ‰å¼Šã€‚å¥½çš„ç‚¹åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å¹¶å‘è®¿é—®çš„é¡ºåºé€»è¾‘ã€‚é¿å…ç¨‹åºå› ä¸ºèµ„æºç«äº‰ï¼Œè€Œå‡ºç°ä¸€äº›é¢„æœŸå¤–çš„æƒ…å†µã€‚
ä¸å¥½çš„ç‚¹åœ¨äºï¼ŒåŠ é”æ„å‘³ç€å¹¶å‘åº¦çš„ä¸‹é™ï¼Œæ•ˆç‡çš„ä¸‹é™ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨é”æ¥å®Œæˆä¸šåŠ¡éœ€æ±‚çš„æ—¶å€™ï¼Œä¹Ÿè¦è€ƒè™‘é”ç«äº‰å¯¹ä¸šåŠ¡å¸¦æ¥çš„å½±å“ã€‚æ ¹æ®ä¸šåŠ¡æƒ…å†µç¡®å®šæ˜¯å¦ä½¿ç”¨åŠä½¿ç”¨çš„æ–¹å¼ã€‚</p>
<h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#æ•°æ®ç»“æ„">#</a></h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// A Mutex is a mutual exclusion lock.
</span></span><span style="display:flex;"><span>// The zero Val for a Mutex is an unlocked mutex.
</span></span><span style="display:flex;"><span>//
</span></span><span style="display:flex;"><span>// A Mutex must not be copied after first use.
</span></span><span style="display:flex;"><span>type Mutex struct {
</span></span><span style="display:flex;"><span>	state int32
</span></span><span style="display:flex;"><span>	sema  uint32
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// A Locker represents an object that can be locked and unlocked.
</span></span><span style="display:flex;"><span>type Locker interface {
</span></span><span style="display:flex;"><span>	Lock()
</span></span><span style="display:flex;"><span>	Unlock()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const (
</span></span><span style="display:flex;"><span>	mutexLocked = 1 &lt;&lt; iota // mutex is locked
</span></span><span style="display:flex;"><span>	mutexWoken
</span></span><span style="display:flex;"><span>	mutexStarving
</span></span><span style="display:flex;"><span>	mutexWaiterShift = iota
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	// Mutex fairness.
</span></span><span style="display:flex;"><span>	//
</span></span><span style="display:flex;"><span>	// Mutex can be in 2 modes of operations: normal and starvation.
</span></span><span style="display:flex;"><span>	// In normal mode waiters are queued in FIFO order, but a woken up waiter
</span></span><span style="display:flex;"><span>	// does not own the mutex and competes with new arriving goroutines over
</span></span><span style="display:flex;"><span>	// the ownership. New arriving goroutines have an advantage -- they are
</span></span><span style="display:flex;"><span>	// already running on CPU and there can be lots of them, so a woken up
</span></span><span style="display:flex;"><span>	// waiter has good chances of losing. In such case it is queued at front
</span></span><span style="display:flex;"><span>	// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,
</span></span><span style="display:flex;"><span>	// it switches mutex to the starvation mode.
</span></span><span style="display:flex;"><span>	//
</span></span><span style="display:flex;"><span>	// In starvation mode ownership of the mutex is directly handed off from
</span></span><span style="display:flex;"><span>	// the unlocking goroutine to the waiter at the front of the queue.
</span></span><span style="display:flex;"><span>	// New arriving goroutines don&#39;t try to acquire the mutex even if it appears
</span></span><span style="display:flex;"><span>	// to be unlocked, and don&#39;t try to spin. Instead they queue themselves at
</span></span><span style="display:flex;"><span>	// the tail of the wait queue.
</span></span><span style="display:flex;"><span>	//
</span></span><span style="display:flex;"><span>	// If a waiter receives ownership of the mutex and sees that either
</span></span><span style="display:flex;"><span>	// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,
</span></span><span style="display:flex;"><span>	// it switches mutex back to normal operation mode.
</span></span><span style="display:flex;"><span>	//
</span></span><span style="display:flex;"><span>	// Normal mode has considerably better performance as a goroutine can acquire
</span></span><span style="display:flex;"><span>	// a mutex several times in a row even if there are blocked waiters.
</span></span><span style="display:flex;"><span>	// Starvation mode is important to prevent pathological cases of tail latency.
</span></span><span style="display:flex;"><span>	starvationThresholdNs = 1e6
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ä»£ç å°±æ˜¯go1.18ä¸­sync.mutexçš„å®šä¹‰ã€‚å¯ä»¥çœ‹åˆ°Mutexç»“æ„ä½“ä¸­æœ‰stateå’Œsemaä¸¤ä¸ªå­—æ®µï¼Œ</p>
<ul>
<li>state int32ç±»å‹ï¼Œä»£è¡¨çš„æ˜¯é”çš„çŠ¶æ€.</li>
<li>sema uint32ç±»å‹ï¼Œä»£è¡¨<a href="https://zh.wikipedia.org/wiki/%E4%BF%A1%E5%8F%B7%E9%87%8F">ä¿¡å·é‡</a>ã€‚ä»–ä¸»è¦ç”¨äºå”¤é†’é˜»å¡åœ¨äº’æ–¥é”ä¸Šçš„å…¶ä»–åç¨‹ã€‚</li>
</ul>
<h4 id="é”çš„çŠ¶æ€">é”çš„çŠ¶æ€<a hidden class="anchor" aria-hidden="true" href="#é”çš„çŠ¶æ€">#</a></h4>
<p><img loading="lazy" src="https://youngergo.cn/images/tech/go-sync.mutex/mutexStruct.png" alt="m.state"  />
</p>
<p>å›¾ç‰‡æ¥è‡ªDravenesså¤§ç¥ï¼Œstateæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p>
<ul>
<li>mutexLockedã€‚é”çŠ¶æ€ï¼Œå 1bitï¼Œ0-å¯ä»¥è·å–é”ï¼Œ1-é”å®šçŠ¶æ€ï¼Œé˜»å¡ç­‰å¾…</li>
<li>mutexWokenã€‚å”¤é†’çŠ¶æ€ã€‚å 1bitï¼Œä»£è¡¨ä¸€ä¸ªè¿‡ç¨‹é˜¶æ®µï¼Œ0-æ²¡æœ‰åç¨‹å”¤é†’ 1-æœ‰åç¨‹è¢«å”¤é†’ï¼Œç”³è¯·é”å®šè¿‡ç¨‹ä¸­ã€‚</li>
<li>mutexStarvingã€‚é¥¥é¥¿çŠ¶æ€ã€‚å 1bitï¼Œå½“åç¨‹è¶…è¿‡1msè¿˜æ²¡æœ‰è·å–é”æ—¶ï¼Œé”å°±ä¼šå¤„äºé¥¥é¥¿çŠ¶æ€ã€‚</li>
<li>mutexWaiterShift/waitersCountã€‚ç­‰å¾…ä¿¡å·é‡çŠ¶æ€ã€‚å 29bitï¼Œå½“æœ‰åç¨‹é‡Šæ”¾é”æ—¶ï¼Œéœ€è¦æ ¹æ®æ­¤çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦é‡Šæ”¾ä¿¡å·é‡ã€‚ç”¨äºé€šçŸ¥å…¶ä»–åç¨‹è·å–æ­¤é”ã€‚</li>
</ul>
<h3 id="å®ç°åŸç†">å®ç°åŸç†<a hidden class="anchor" aria-hidden="true" href="#å®ç°åŸç†">#</a></h3>
<p>sync.Mutexçš„å®ç°ä»£ç åªæœ‰200å¤šè¡Œï¼Œä½†æ˜¯é‡Œé¢é”çš„åˆ‡æ¢æ§åˆ¶è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œä¸‹é¢æˆ‘ä»¬é€æ­¥æ¥åˆ†æ</p>
<h4 id="åŠ é”è¿‡ç¨‹">åŠ é”è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åŠ é”è¿‡ç¨‹">#</a></h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Lock locks m.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// If the lock is already in use, the calling goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// blocks until the mutex is available.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">Lock</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Fast path: grab unlocked mutex.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">mutexLocked</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">race</span>.<span style="color:#a6e22e">Enabled</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">race</span>.<span style="color:#a6e22e">Acquire</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">m</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Slow path (outlined so that the fast path can be inlined)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">lockSlow</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Lockå‡½æ•°ä½¿ç”¨CompareAndSwapInt32åˆ¤æ–­m.stateæ˜¯ä¸æ˜¯0ï¼Œå¦‚æœæ˜¯çš„è¯stateè®¾ä¸ºlockçŠ¶æ€ï¼ŒæˆåŠŸè·å–åˆ°é”ã€‚
å¤±è´¥åˆ™è°ƒç”¨lockSlow()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å®ç°çŠ¶æ€æ§åˆ¶çš„ä¸»è¦é€»è¾‘ã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">lockSlow</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">waitStartTime</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">starving</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">awoke</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">iter</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">old</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Don&#39;t spin in starvation mode, ownership is handed off to waiters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// so we won&#39;t be able to acquire the mutex anyway.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span>(<span style="color:#a6e22e">mutexLocked</span>|<span style="color:#a6e22e">mutexStarving</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">mutexLocked</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">runtime_canSpin</span>(<span style="color:#a6e22e">iter</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Active spinning makes sense.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// Try to set mutexWoken flag to inform Unlock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// to not wake other blocked goroutines.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">awoke</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mutexWoken</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#a6e22e">mutexWaiterShift</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">old</span>|<span style="color:#a6e22e">mutexWoken</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">awoke</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">runtime_doSpin</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">iter</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">old</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">new</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">old</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Don&#39;t try to acquire starving mutex, new arriving goroutines must queue.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mutexStarving</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">new</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">mutexLocked</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span>(<span style="color:#a6e22e">mutexLocked</span>|<span style="color:#a6e22e">mutexStarving</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">new</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">mutexWaiterShift</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// The current goroutine switches mutex to starvation mode.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// But if the mutex is currently unlocked, don&#39;t do the switch.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// Unlock expects that starving mutex has waiters, which will not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// be true in this case.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">starving</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mutexLocked</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">new</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">mutexStarving</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">awoke</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// The goroutine has been woken from sleep,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// so we need to reset the flag in either case.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">new</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mutexWoken</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;sync: inconsistent mutex state&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">new</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#a6e22e">mutexWoken</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span>(<span style="color:#a6e22e">mutexLocked</span>|<span style="color:#a6e22e">mutexStarving</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span> <span style="color:#75715e">// locked the mutex with CAS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// If we were already waiting before, queue at the front of the queue.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">queueLifo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">waitStartTime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">waitStartTime</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">waitStartTime</span> = <span style="color:#a6e22e">runtime_nanotime</span>()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">runtime_SemacquireMutex</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">sema</span>, <span style="color:#a6e22e">queueLifo</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">starving</span> = <span style="color:#a6e22e">starving</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">runtime_nanotime</span>()<span style="color:#f92672">-</span><span style="color:#a6e22e">waitStartTime</span> &gt; <span style="color:#a6e22e">starvationThresholdNs</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">old</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mutexStarving</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// If this goroutine was woken and mutex is in starvation mode,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// ownership was handed off to us but mutex is in somewhat
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// inconsistent state: mutexLocked is not set and we are still
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// accounted as waiter. Fix that.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span>(<span style="color:#a6e22e">mutexLocked</span>|<span style="color:#a6e22e">mutexWoken</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#a6e22e">mutexWaiterShift</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;sync: inconsistent mutex state&#34;</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">delta</span> <span style="color:#f92672">:=</span> int32(<span style="color:#a6e22e">mutexLocked</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#a6e22e">mutexWaiterShift</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">starving</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#a6e22e">mutexWaiterShift</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Exit starvation mode.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// Critical to do it here and consider wait time.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// Starvation mode is so inefficient, that two goroutines
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// can go lock-step infinitely once they switch mutex
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// to starvation mode.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#a6e22e">delta</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">mutexStarving</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">delta</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">awoke</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">iter</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">old</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">race</span>.<span style="color:#a6e22e">Enabled</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">race</span>.<span style="color:#a6e22e">Acquire</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">m</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>slowLockå‡½æ•°ä¾é CAS+ä¿¡å·é‡+è‡ªæ—‹æ¥å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹ç…§ä»£ç ï¼Œé€è¡Œåˆ†æä¸‹é€»è¾‘ï¼š</p>
<ul>
<li>
<p>1.åœ¨è°ƒç”¨slowLockä¹‹å‰ï¼Œå·²ç»åˆ¤æ–­è¿‡stateæ˜¯å¦å¯ä»¥è·å–é”ã€‚è¿›å…¥slowLockåä¼šé˜»å¡å½“å‰Gï¼Œå°è¯•è·å–é”ã€‚ é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼š
ã€é”å¤„äºéé¥¥é¥¿çŠ¶æ€, lockedçŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥è‡ªæ—‹ã€‘ï¼Œæ»¡è¶³å³å¼€å§‹è‡ªæ—‹ï¼Œåœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­å°è¯•å°†é”çš„çŠ¶æ€è®¾ç½®ä¸ºå”¤é†’ï¼Œå°½é‡è®©å½“å‰Gè·å–çš„é”ã€‚</p>
</li>
<li>
<p>2.å½“åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­å‘ç°å¯ä»¥è·å–é”æ—¶ï¼Œè¿›å…¥ä¸‹é¢é€»è¾‘ã€‚ç”¨oldåˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶çš„new stateã€‚åˆ¤æ–­é”å¦‚æœä¸å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œnew stateåŠ ä¸ŠlockedçŠ¶æ€ã€‚
(é¥¥é¥¿çŠ¶æ€ä¸‹çš„é”ï¼ŒGæ˜¯éœ€è¦æ’é˜Ÿæ‰å¯ä»¥è·å–çš„ï¼Œæºç æ³¨é‡Šä¹Ÿæœ‰)ã€‚æ¥ç€ï¼Œåˆ¤æ–­oldçŠ¶æ€æ˜¯lockedæˆ–è€…é¥¥é¥¿æ—¶ï¼Œå°†waiterShiftåŠ 8ï¼Œä»£è¡¨ç­‰å¾…çš„GåŠ 1ã€‚
æ¥ç€åˆ¤æ–­å¦‚æœæ­¤Gå·²ç»å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œå¹¶ä¸”oldå·²ç»å¤„äºlockedçŠ¶æ€ã€‚new stateå°±å¢åŠ é¥¥é¥¿çŠ¶æ€ã€‚(æ–‡ä¸­çš„ç¿»è¯‘è¯´æ˜äº†åŸå› ï¼Œå½“å‰çš„goroutineå°†mutexè®¾ä¸ºé¥¥é¥¿çŠ¶æ€ï¼Œ
ä½†æ˜¯å¦‚æœmutexå·²ç»è§£é”çš„è¯ï¼Œå°±ä¸è¦è¿›è¡Œè®¾å®šäº†ã€‚å› ä¸ºUnlockéœ€è¦å¤„äºé¥¥é¥¿çŠ¶æ€çš„mutexæœ‰ç­‰å¾…è€…)ã€‚ åˆ¤æ–­å½“å‰Gæ˜¯å¦æ˜¯è¢«å”¤é†’çš„ï¼Œæ˜¯çš„è¯å°†new stateè®¾ç½®æˆéå”¤é†’ã€‚</p>
</li>
<li>
<p>3.æ¥ä¸‹æ¥è¦æ³¨æ„ï¼Œè¿™é‡Œå†æ¬¡å°†m.stateå’Œoldè¿›è¡Œäº†æ¯”è¾ƒã€‚ä¸»è¦æ˜¯åˆ¤æ–­æœ‰å…¶ä»–çš„goroutineæ”¹å˜mutexçš„çŠ¶æ€ã€‚å¦‚æœæœ‰çš„è¯new stateå°±ä½œåºŸï¼Œå®Œæˆæœ¬æ¬¡é€»è¾‘ï¼Œç»§ç»­å¾ªç¯è‡ªæ—‹å°è¯•è·å–é”ã€‚
å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå½“å‰æ— é”+ä¸é¥¥é¥¿å°±å¯ä»¥è·å–é”æˆåŠŸbreakã€‚å¦åˆ™åŠ é”å¤±è´¥ï¼ŒGéœ€è¦è¿›å…¥é˜Ÿåˆ—ï¼Œå¦‚æœGç¬¬ä¸€æ¬¡ç­‰å¾…å°±æ”¾åœ¨é˜Ÿå°¾ï¼Œå¦åˆ™å°±æ˜¯è¢«å”¤é†’å†æ¬¡è·å–é”å¤±è´¥ã€‚å°±ä¼šè¢«æ”¾åœ¨é˜Ÿé¦–ã€‚
åˆ¤æ–­å½“å‰Gæ˜¯å¦è¯¥è¿›å…¥é¥¥é¥¿çŠ¶æ€çš„æ ‡å‡†æ˜¯Gç­‰å¾…mutexçš„æ—¶é—´æ˜¯å¦å¤§äº1msã€‚é‡æ–°è·å–mutexçš„çŠ¶æ€ï¼Œå¦‚æœå¤„äºé¥¥é¥¿çŠ¶æ€è·å–é”æˆåŠŸã€‚æ­¤æ—¶éœ€è¦è€ƒè™‘è§£é™¤é”çš„é¥¥é¥¿çŠ¶æ€ã€‚
æ»¡è¶³1.å½“å‰Gç­‰å¾…æ—¶é—´å°äº1ms 2.ç­‰å¾…é˜Ÿåˆ—ä¸ºç©º ä¸¤ä¸ªæ¡ä»¶å…¶ä¸€å³å¯é€€å‡ºé¥¥é¥¿æ¨¡å¼ã€‚</p>
</li>
</ul>
<p>ä¸Šé¢æ˜¯å¯¹ç…§ä»£ç çš„ç†è§£è¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬æ€»ç»“ä¸‹ï¼š
æ­£å¸¸æƒ…å†µä¸‹, å½“ä¸€ä¸ªGoroutineè·å–åˆ°é”å, å…¶ä»–çš„Gè·å–é”æ—¶ä¼šè‡ªæ—‹æˆ–è€…è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…ä¿¡å·é‡å”¤é†’ï¼Œè‡ªæ—‹æ˜¯å¸Œæœ›å½“å‰çš„Gèƒ½è·å–åˆ°é”ï¼Œå› ä¸ºå®ƒæŒæœ‰CPUï¼Œ
å¯ä»¥é¿å…èµ„æºåˆ‡æ¢ã€‚ä½†æ˜¯åˆä¸èƒ½ä¸€ç›´è‡ªæ—‹ï¼Œ æ‰€ä»¥mutexå°±ä¼šæœ‰é¥¥é¥¿æ¨¡å¼ï¼Œå¦‚æœä¸€ä¸ªGè¢«å”¤é†’è¿‡å, ä»ç„¶æ²¡æœ‰æ‹¿åˆ°é”, é‚£ä¹ˆè¯¥Gä¼šæ”¾åœ¨ç­‰å¾…é˜Ÿåˆ—çš„æœ€å‰é¢ã€‚
å¹¶ä¸”é‚£äº›ç­‰å¾…è¶…è¿‡1msçš„Gè¿˜æ²¡æœ‰è·å–åˆ°é”ï¼Œè¯¥Gå°±ä¼šè¿›å…¥é¥¥é¥¿çŠ¶æ€ã€‚è¯¥Gæ˜¯é¥¥é¥¿çŠ¶æ€å¹¶ä¸”Mutexæ˜¯LockedçŠ¶æ€æ—¶ï¼Œæ‰æœ‰å¯èƒ½ç»™Mutexè®¾ç½®æˆé¥¥é¥¿çŠ¶æ€ã€‚</p>
<p>è·å–åˆ°é”çš„Gè§£é”æ—¶ï¼Œå°†mutexçš„çŠ¶æ€è®¾ä¸ºunlockï¼Œç„¶åå‘å‡ºä¿¡å·ï¼Œç­‰å¾…çš„Gå¼€å§‹æŠ¢å¤ºé”çš„ã€‚ä½†æ˜¯å¦‚æœmutexå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œå°±ä¼šå°†ä¿¡å·å‘ç»™ç¬¬ä¸€ä¸ªGï¼Œå”¤é†’å®ƒã€‚è¿™å°±æ˜¯Gæ’é˜Ÿã€‚</p>
<h4 id="è§£é”è¿‡ç¨‹">è§£é”è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#è§£é”è¿‡ç¨‹">#</a></h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Unlock unlocks m.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// It is a run-time error if m is not locked on entry to Unlock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// A locked Mutex is not associated with a particular goroutine.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// It is allowed for one goroutine to lock a Mutex and then
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// arrange for another goroutine to unlock it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">Unlock</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">race</span>.<span style="color:#a6e22e">Enabled</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">race</span>.<span style="color:#a6e22e">Release</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">m</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Fast path: drop lock bit.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">new</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">mutexLocked</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">new</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Outlined slow path to allow inlining the fast path.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">unlockSlow</span>(<span style="color:#a6e22e">new</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mutex</span>) <span style="color:#a6e22e">unlockSlow</span>(<span style="color:#a6e22e">new</span> <span style="color:#66d9ef">int32</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">new</span><span style="color:#f92672">+</span><span style="color:#a6e22e">mutexLocked</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mutexLocked</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;sync: unlock of unlocked mutex&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">new</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mutexStarving</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">old</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">new</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// If there are no waiters or a goroutine has already
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// been woken or grabbed the lock, no need to wake anyone.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// In starvation mode ownership is directly handed off from unlocking
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// goroutine to the next waiter. We are not part of this chain,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// since we did not observe mutexStarving when we unlocked the mutex above.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// So get off the way.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#a6e22e">mutexWaiterShift</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">old</span><span style="color:#f92672">&amp;</span>(<span style="color:#a6e22e">mutexLocked</span>|<span style="color:#a6e22e">mutexWoken</span>|<span style="color:#a6e22e">mutexStarving</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Grab the right to wake someone.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">new</span> = (<span style="color:#a6e22e">old</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#a6e22e">mutexWaiterShift</span>) | <span style="color:#a6e22e">mutexWoken</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">runtime_Semrelease</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">sema</span>, <span style="color:#66d9ef">false</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">old</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Starving mode: handoff mutex ownership to the next waiter, and yield
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// our time slice so that the next waiter can start to run immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// Note: mutexLocked is not set, the waiter will set it after wakeup.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// But mutex is still considered locked if mutexStarving is set,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// so new coming goroutines won&#39;t acquire it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">runtime_Semrelease</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">sema</span>, <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£é™¤mutexçš„lockçŠ¶æ€ï¼Œè·å–åˆ°æœ€æ–°çš„çŠ¶æ€newã€‚å¦‚æœnewæ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå”¤é†’ç¬¬ä¸€ä¸ªGï¼Œè·å–é”ã€‚è§£é”å®Œæˆã€‚
å¦‚æœä¸æ˜¯é¥¥é¥¿çŠ¶æ€ã€‚å½“å‰æ²¡æœ‰Gç­‰å¾…ï¼Œæˆ–è€…æœ‰Gå·²ç»è¢«å”¤é†’å»åŠ é”äº†ã€‚å°±ä¸éœ€è¦åšå”¤é†’çš„åŠ¨ä½œã€‚é€€å‡ºå³å¯ã€‚
å¦åˆ™å°†ç­‰å¾…çš„G-1ï¼Œå¹¶ä¸€ç›´å°è¯•å°†Gè®¾ç½®ä¸ºå”¤é†’çŠ¶æ€ï¼Œé‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥æ‰€æœ‰çš„Géƒ½å¯ä»¥å»æŠ¢å¤ºé”ã€‚è®¾ç½®æˆåŠŸè§£é”å®Œæˆï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œã€‚</p>
<h3 id="å¼•ç”³é—®é¢˜">å¼•ç”³é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å¼•ç”³é—®é¢˜">#</a></h3>
<h4 id="æºç é˜…è¯»æ³¨æ„çš„ç‚¹">æºç é˜…è¯»æ³¨æ„çš„ç‚¹<a hidden class="anchor" aria-hidden="true" href="#æºç é˜…è¯»æ³¨æ„çš„ç‚¹">#</a></h4>
<p>åœ¨ç†è§£sync.mutexçš„æ—¶å€™ï¼Œä¸€å®šè¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œmçš„stateåœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¾ˆå¯èƒ½ä¼šæœ‰å…¶ä»–çš„Gæ”¹å˜å…¶çŠ¶æ€ã€‚æ‰€ä»¥æŸ¥çœ‹ä»£ç é€»è¾‘çš„æ—¶å€™ï¼Œ
ä¸€å®šè¦æ—¶åˆ»è®°å¾—è¿™ä¸ªç‚¹</p>
<h4 id="wokençŠ¶æ€çš„æ„ä¹‰">wokençŠ¶æ€çš„æ„ä¹‰<a hidden class="anchor" aria-hidden="true" href="#wokençŠ¶æ€çš„æ„ä¹‰">#</a></h4>
<p>WokençŠ¶æ€ç”¨äºåŠ é”å’Œè§£é”è¿‡ç¨‹çš„é€šä¿¡ï¼Œä¸¾ä¸ªä¾‹å­ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œä¸¤ä¸ªåç¨‹ä¸€ä¸ªåœ¨åŠ é”ï¼Œä¸€ä¸ªåœ¨è§£é”ï¼Œåœ¨åŠ é”çš„åç¨‹å¯èƒ½åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œ
æ­¤æ—¶æŠŠWokenæ ‡è®°ä¸º1ï¼Œç”¨äºé€šçŸ¥è§£é”åç¨‹ä¸å¿…é‡Šæ”¾ä¿¡å·é‡äº†ï¼Œå¥½æ¯”åœ¨è¯´ï¼šä½ åªç®¡è§£é”å¥½äº†ï¼Œä¸å¿…é‡Šæ”¾ä¿¡å·é‡ï¼Œæˆ‘é©¬ä¸Šå°±æ‹¿åˆ°é”äº†ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆé‡å¤è§£é”ä¼španic">ä¸ºä»€ä¹ˆé‡å¤è§£é”ä¼španic<a hidden class="anchor" aria-hidden="true" href="#ä¸ºä»€ä¹ˆé‡å¤è§£é”ä¼španic">#</a></h4>
<p>Unlockçš„é€»è¾‘æ˜¯ï¼Œè§£é™¤mutexçš„lockçŠ¶æ€ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦æœ‰åç¨‹ç­‰å¾…ï¼Œæœ‰çš„è¯é‡Šæ”¾ä¿¡å·é‡ï¼Œå”¤é†’åç¨‹ã€‚å¦‚æœå¤šæ¬¡unlockçš„è¯ï¼Œå°±ä¼š
å‘é€å¤šä¸ªä¿¡å·é‡ï¼Œå”¤é†’å¤šä¸ªGå»æŠ¢å¤ºé”ã€‚ä¼šé€ æˆä¸å¿…è¦çš„ç«äº‰ï¼Œä¹Ÿä¼šé€ æˆåç¨‹åˆ‡æ¢ï¼Œæµªè´¹èµ„æºï¼Œå®ç°å¤æ‚åº¦ä¹Ÿä¼šå¢åŠ ã€‚</p>
<h4 id="gçš„é¥¥é¥¿å’Œmutexé¥¥é¥¿çš„å…³ç³»">Gçš„é¥¥é¥¿å’Œmutexé¥¥é¥¿çš„å…³ç³»<a hidden class="anchor" aria-hidden="true" href="#gçš„é¥¥é¥¿å’Œmutexé¥¥é¥¿çš„å…³ç³»">#</a></h4>
<p>åªæœ‰Gå¤„äºé¥¥é¥¿çŠ¶æ€çš„æ—¶å€™ï¼Œæ‰ä¼šå°†mutexè®¾ä¸ºé¥¥é¥¿çŠ¶æ€ã€‚å½“mutexå¤„äºé¥¥é¥¿çŠ¶æ€æ—¶ï¼Œæ‰å¯èƒ½ä¼šè®©é¥¥é¥¿çš„Gè·å–åˆ°é”ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®¾mutex
ä¸ºé¥¥é¥¿çŠ¶æ€çš„Gä¸ä¸€å®šä¼šè·å–åˆ°é”ï¼Œæœ‰å¯èƒ½ä¼šè¢«å…¶ä»–Gæˆªèƒ¡ã€‚</p>
<h4 id="gå¯ä»¥æˆåŠŸè·å–é”çš„æƒ…å†µ">Gå¯ä»¥æˆåŠŸè·å–é”çš„æƒ…å†µ<a hidden class="anchor" aria-hidden="true" href="#gå¯ä»¥æˆåŠŸè·å–é”çš„æƒ…å†µ">#</a></h4>
<ul>
<li>ç¬¬ä¸€æ¬¡åŠ é”çš„æ—¶å€™m.state=0ï¼Œä¸€å®šæ˜¯å¯ä»¥è·å–é”ã€‚æ²¡æœ‰å…¶ä»–çš„Gè·å–é”ï¼Œæ²¡æœ‰æ”¹å˜å…¶çŠ¶æ€ã€‚</li>
<li>å½“å‰çš„mutexä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯lockçŠ¶æ€ï¼Œå°è¯•CASåŠ é”çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–Gæ”¹å˜mçŠ¶æ€ï¼Œå¯ä»¥æˆåŠŸã€‚</li>
<li>æŸä¸ªGè¢«å”¤é†’åï¼Œé‡æ–°è·å–mutexï¼Œæ­¤æ—¶mutexå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œæ²¡æœ‰å…¶ä»–çš„Gæ¥æŠ¢å¤ºï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™åªå”¤é†’äº†é¥¥é¥¿çš„Gï¼ŒGä¹Ÿå¯ä»¥æˆåŠŸã€‚</li>
</ul>
<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒèµ„æ–™">#</a></h3>
<ul>
<li><a href="https://blog.csdn.net/baolingye/article/details/111357407">https://blog.csdn.net/baolingye/article/details/111357407</a></li>
<li><a href="https://blog.csdn.net/qq_37102984/article/details/115322706">https://blog.csdn.net/qq_37102984/article/details/115322706</a></li>
<li><a href="https://mp.weixin.qq.com/s/BZvfNn_Vre7o2T8BZ4LLMw">https://mp.weixin.qq.com/s/BZvfNn_Vre7o2T8BZ4LLMw</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://younger027.github.io/en/tags/golang/">golang</a></li>
      <li><a href="https://younger027.github.io/en/tags/%E6%BA%90%E7%A0%81/">æºç </a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://younger027.github.io/en/posts/tech/go-chan/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Go Chan</span>
  </a>
  <a class="next" href="https://younger027.github.io/en/posts/life/me/">
    <span class="title">Next Â»</span>
    <br>
    <span>Me</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://younger027.github.io/en/">Younger&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
