<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go Ants | Younger&#39;s Blog</title>
<meta name="keywords" content="golang, æºç ">
<meta name="description" content="ç®€ä»‹ ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangçš„goroutineæ˜¯goå¹¶å‘ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ç®€å•go func()å°±å¯ä»¥å¼€å¯ä¸€ä¸ªgoåç¨‹ï¼Œç„¶åè°ƒåº¦å™¨">
<meta name="author" content="Younger">
<link rel="canonical" href="https://younger027.github.io/en/posts/tech/go-ants/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="apple-touch-icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="mask-icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Go Ants" />
<meta property="og:description" content="ç®€ä»‹ ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangçš„goroutineæ˜¯goå¹¶å‘ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ç®€å•go func()å°±å¯ä»¥å¼€å¯ä¸€ä¸ªgoåç¨‹ï¼Œç„¶åè°ƒåº¦å™¨" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://younger027.github.io/en/posts/tech/go-ants/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-13T16:40:32+08:00" />
<meta property="article:modified_time" content="2023-03-13T16:40:32+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go Ants"/>
<meta name="twitter:description" content="ç®€ä»‹ ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangçš„goroutineæ˜¯goå¹¶å‘ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ç®€å•go func()å°±å¯ä»¥å¼€å¯ä¸€ä¸ªgoåç¨‹ï¼Œç„¶åè°ƒåº¦å™¨"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://younger027.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://younger027.github.io/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Go Ants",
      "item": "https://younger027.github.io/en/posts/tech/go-ants/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go Ants",
  "name": "Go Ants",
  "description": "ç®€ä»‹ ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangçš„goroutineæ˜¯goå¹¶å‘ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ç®€å•go func()å°±å¯ä»¥å¼€å¯ä¸€ä¸ªgoåç¨‹ï¼Œç„¶åè°ƒåº¦å™¨",
  "keywords": [
    "golang", "æºç "
  ],
  "articleBody": "ç®€ä»‹ ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangçš„goroutineæ˜¯goå¹¶å‘ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ç®€å•go func()å°±å¯ä»¥å¼€å¯ä¸€ä¸ªgoåç¨‹ï¼Œç„¶åè°ƒåº¦å™¨ä¼šç®¡ç†goåç¨‹åˆ†é…ç›¸åº”çš„På’ŒMï¼Œæ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸”å¼€å¯ä¸€ä¸ªgoroutineä»£ä»·å¾ˆå°ï¼Œåªä¼šå ç”¨2kçš„æ ˆç©ºé—´ã€‚ä½†æ˜¯åç¨‹ä¹Ÿä¸æ˜¯éšæ„æƒ³å¼€å¤šå°‘å°±å¤šå°‘ï¼Œè¿‡å¤šçš„goroutineä¸ä»…ä¼šå½±å“è°ƒåº¦å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œä¹Ÿä¼šé€ æˆå†…å­˜çš„å¿«é€Ÿå¢é•¿ã€‚\nä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªgithubä¸Šæœ‰1w starçš„åç¨‹æ± åº“antsã€‚â€œantsæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ goroutine æ± ï¼Œå®ç°äº†å¯¹å¤§è§„æ¨¡ goroutine çš„è°ƒåº¦ç®¡ç†ã€goroutine å¤ç”¨ï¼Œå…è®¸ä½¿ç”¨è€…åœ¨å¼€å‘å¹¶å‘ç¨‹åºçš„æ—¶å€™é™åˆ¶ goroutine æ•°é‡ï¼Œå¤ç”¨èµ„æºï¼Œè¾¾åˆ°æ›´é«˜æ•ˆæ‰§è¡Œä»»åŠ¡çš„æ•ˆæœã€‚ä»benchmarkçš„ç»“æœæ¥çœ‹ï¼Œä½¿ç”¨antsçš„ååæ€§èƒ½ç›¸è¾ƒäºåŸç”Ÿ goroutine å¯ä»¥ä¿æŒåœ¨ 2-6 å€çš„æ€§èƒ½å‹åˆ¶ï¼Œè€Œå†…å­˜æ¶ˆè€—åˆ™å¯ä»¥è¾¾åˆ° 10-20 å€çš„èŠ‚çœä¼˜åŠ¿â€(æ¥è‡ªä»“åº“æè¿°)ï¼Œå…·ä½“çš„ç»†èŠ‚å¯ä»¥çœ‹gitä»“åº“ã€‚\nè®¾è®¡ç†å¿µ antsçš„è®¾è®¡ç†å¿µæ˜¯ä½¿ç”¨Nä¸ªwork goroutine å®ŒæˆMä¸ªtaskçš„æ‰§è¡Œã€‚æ§åˆ¶goroutineçš„æ•°é‡ã€‚å°±åƒä»“åº“ä¸­çš„Activity Diagramsæè¿°çš„é‚£æ ·ã€‚ä½†æ˜¯è¿™æ ·çš„è®¾è®¡ä¹Ÿä¼šæœ‰ä¸€äº›å¼Šç«¯ï¼Œæˆ‘ä»¬åé¢å†èŠã€‚ ç›®å½•ç»“æ„ antsçš„ä»£ç å¹¶ä¸å¤šï¼Œé™¤äº†testå¤–æ€»å…±ä¹Ÿåªæœ‰åå¤šä¸ªæ–‡ä»¶ï¼Œè€Œä¸”ä»£ç è¡Œæ•°ä¹Ÿä¸å¤šï¼Œä¸‹é¢æ˜¯æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæ–‡ä»¶ï¼š\nants.go ants.go å°è£…äº†å¤–éƒ¨è°ƒç”¨çš„èƒ½åŠ›ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€ä¸ªæ—  goroutine é™åˆ¶çš„defaultAntsPoolå¯¹è±¡ï¼Œæä¾›äº†ä»»åŠ¡æäº¤ï¼Œè·å–è¿è¡Œåç¨‹æ•°é‡ï¼Œè·å–å®¹é‡ç­‰èƒ½åŠ›ã€‚ pool.go pool.go å®ç°åç¨‹æ± éœ€è¦çš„èƒ½åŠ›ã€‚åç¨‹æ± çš„å®šä¹‰ï¼Œä»»åŠ¡æäº¤ï¼Œåˆ†é…åç¨‹ç­‰é€»è¾‘å®ç°ï¼Œéƒ½åœ¨è¿™æ–‡ä»¶ä¸­ï¼Œantsä¸­çš„defaultAntsPoolè°ƒç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„å®ç°ã€‚ pool_func.go pool_func.go å’Œpool.goåšçš„äº‹æƒ…å·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºpool.goå¯ä»¥æ‰§è¡Œä¸åŒçš„åç¨‹ä»»åŠ¡ï¼Œpool_func.go æ‰§è¡Œçš„æ˜¯ç›¸åŒçš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥ä¼ ä¸åŒçš„å‚æ•°ã€‚ä½¿ç”¨åœºæ™¯ä¸åŒã€‚ work.go work.go å®Œæˆå…·ä½“ä»»åŠ¡çš„æ‰§è¡ŒgoWorkï¼Œå®ä¾‹åŒ–äº†work_queue.goä¸­worker interfaceçš„å®ç°ã€‚å’Œpool.goå…³è”ã€‚ work_func.go work_func.go å’Œwork.goçš„åšäº†åŒæ ·çš„äº‹æƒ…ï¼Œå®ƒå’Œpool_func.goå…³è”ã€‚ worker_queue.go worker_queue.go worker_queueæ˜¯ç®¡ç†workeræ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå®šä¹‰äº†worker å’Œworker queueéœ€è¦å®ç°çš„èƒ½åŠ›ã€‚ worker_loop_queue.go worker_loop_queue.go ç”¨é˜Ÿåˆ—çš„å½¢å¼å®ç°å¯¹wokeré˜Ÿåˆ—çš„ç®¡ç†ã€‚ worker_stack.go worker_stack.go ä»¥æ ˆçš„å½¢å¼å®ç°workeré˜Ÿåˆ—ç®¡ç† options.go options.go antså¯¹è±¡çš„ä¸€äº›é…ç½®ç‰¹æ€§ è¿™äº›å°±æ˜¯antsçš„ä¸»è¦æ–‡ä»¶ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¾ˆç®€å•ï¼ŒworkerQueue interfaceå®šä¹‰äº†workeré˜Ÿåˆ—çš„èƒ½åŠ›ï¼Œæœ‰ring queueå’Œstackä¸¤ç§å®ç°ã€‚woker interfaceå®šä¹‰äº†workçš„èƒ½åŠ›ï¼Œæœ‰workå’Œwork_funcä¸¤ç§å®ç°ã€‚åç¨‹æ± ä¹Ÿå°±æœ‰å¯¹åº”poolå’Œpool_funcä¸¤ç§å®ç°ã€‚\næºç è§£æ antsçš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚ï¼Œå®ƒå®ç°äº†ä¸¤ç§èƒ½åŠ›çš„åç¨‹æ± ï¼Œpoolæ˜¯å¯ä»¥æ‰§è¡Œä¸åŒä»»åŠ¡çš„åç¨‹æ± ï¼ŒpoolWithFuncåªèƒ½æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ï¼Œä½†æ˜¯å‚æ•°å¯ä»¥ä¸åŒã€‚å¯¹åº”æ­¤ä¸¤ç§èƒ½åŠ›ï¼Œæ‰€ä»¥æœ‰äº†goWorkerå’ŒgoWokerWithFuncä¸¤ç§workerã€‚æˆ‘ä»¬å…ˆä»‹ç»poolç›¸å…³æºç (poolå…³è”work.goä¸­çš„goWorker)ï¼Œå¤§å®¶å¯ä»¥å¯¹ç…§é˜…è¯»poolWithFuncçš„ä»£ç ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆä»exampleå…¥æ‰‹ï¼š(ä¸€èˆ¬å¼€æºçš„ä»£ç éƒ½ä¼šæœ‰exampleæ–‡ä»¶ï¼Œæˆ‘ä»¬å­¦ä¹ ä¹‹å‰å¯ä»¥å…ˆä»è¿™äº›ç¤ºä¾‹å…¥æ‰‹ï¼Œç„¶åé’ˆå¯¹æ„Ÿå…´è¶£çš„æ¨¡å—é€å±‚æ·±å…¥ï¼Œè¿™æ ·æ•ˆç‡ä¼šé«˜ç‚¹)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 //https://github.com/panjf2000/ants/blob/dev/examples/main.go package main import ( \"fmt\" \"sync\" \"sync/atomic\" \"time\" \"github.com/panjf2000/ants/v2\" ) var sum int32 func myFunc(i interface{}) { n := i.(int32) atomic.AddInt32(\u0026sum, n) fmt.Printf(\"run with %d\\n\", n) } func demoFunc() { time.Sleep(10 * time.Millisecond) fmt.Println(\"Hello World!\") } func main() { defer ants.Release() runTimes := 1000 // Use the common pool. var wg sync.WaitGroup syncCalculateSum := func() { demoFunc() wg.Done() } for i := 0; i \u003c runTimes; i++ { wg.Add(1) _ = ants.Submit(syncCalculateSum) } wg.Wait() fmt.Printf(\"running goroutines: %d\\n\", ants.Running()) fmt.Printf(\"finish all tasks.\\n\") // Use the pool with a method, // set 10 to the capacity of goroutine pool and 1 second for expired duration. p, _ := ants.NewPoolWithFunc(10, func(i interface{}) { myFunc(i) wg.Done() }) defer p.Release() // Submit tasks one by one. for i := 0; i \u003c runTimes; i++ { wg.Add(1) _ = p.Invoke(int32(i)) } wg.Wait() fmt.Printf(\"running goroutines: %d\\n\", p.Running()) fmt.Printf(\"finish all tasks, result is %d\\n\", sum) if sum != 499500 { panic(\"the final result is wrong!!!\") } } æµ‹è¯•ä»£ç ä»‹ç»äº†poolå’ŒpoolWithFuncçš„ä½¿ç”¨ã€‚syncCalculateSumå‡½æ•°å°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œants.Submit(syncCalculateSum)å°†ä»»åŠ¡æäº¤åˆ°poolä¸­ï¼Œç„¶åä¼šåˆ†é…ç»™workå»æ‰§è¡Œã€‚é‚£ä¹ˆæˆ‘ä»¬å»çœ‹çœ‹Submitå…·ä½“å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 //é¦–å…ˆå…ˆäº†è§£ä¸‹goWorkerçš„å®šä¹‰ //https://github.com/panjf2000/ants/blob/dev/work.go type goWorker struct { // åç¨‹æ± å¯¹è±¡ï¼Œå…¶å®å¤šä¸ªgoWorkerå…±äº«çš„æ˜¯ä¸€ä¸ªpoolå¯¹è±¡ï¼Œåœ¨åˆ›å»ºworkeræ˜¯ä¼ çš„åŒä¸€ä¸ªpï¼Œä¸‹é¢ä»£ç ä¼šè®²ã€‚ pool *Pool // æ¥å—ä»»åŠ¡çš„æœ‰ç¼“å†²çš„chan task chan func() // ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´ï¼Œä¸»è¦æ˜¯æ¸…ç†workeræ—¶ä½¿ç”¨ lastUsed time.Time } //https://github.com/panjf2000/ants/blob/dev/pool.go type Pool struct { // åç¨‹æ± çš„å®¹é‡ï¼Œè´Ÿæ•°ä»£è¡¨æ— é™åˆ¶ capacity int32 //å½“å‰åœ¨è¿è¡Œçš„workeræ•°é‡ running int32 //ä¿æŠ¤ä»é˜Ÿåˆ—ä¸­è¯»å†™worker lock sync.Locker // workersé˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—æœ‰stackå’Œring queueä¸¤ç§å®ç° workers workerQueue //åç¨‹æ± çŠ¶æ€ state int32 //è‡ªæ—‹é”ï¼Œç­‰å¾…è·å–ç©ºé—²çš„worker cond *sync.Cond // workerCache ä½¿ç”¨å¯¹è±¡æ± ï¼ŒåŠ å¿«äº†åœ¨ function:retrieveWorker ä¸­è·å–å¯ç”¨ Worker çš„é€Ÿåº¦ã€‚ workerCache sync.Pool // é˜»å¡åœ¨condä¸Šçš„ä»»åŠ¡æ•°é‡ waiting int32 //æ¸…ç†ç­‰å¾…æ—¶é—´è¿‡é•¿çš„worker purgeDone int32 stopPurge context.CancelFunc //æ›´æ–°workerçš„ä½¿ç”¨æ—¶é—´ï¼Œä¹Ÿæ˜¯ç”¨äºæ¸…ç† ticktockDone int32 stopTicktock context.CancelFunc //ä½¿ç”¨æ—¶é—´ now atomic.Value //é…ç½®ä¿¡æ¯ options *Options } //https://github.com/panjf2000/ants/blob/dev/pool.go func (p *Pool) Submit(task func()) error { //åˆ¤æ–­åç¨‹æ± æ˜¯å¦å…³é—­ if p.IsClosed() { return ErrPoolClosed } //æ£€ç´¢å‡ºä¸€ä¸ªå¯ç”¨çš„workï¼Œç„¶åå°†ä»»åŠ¡äº¤ç»™workå»æ‰§è¡Œ if w := p.retrieveWorker(); w != nil { w.inputFunc(task) return nil } return ErrPoolOverload //https://github.com/panjf2000/ants/blob/dev/pool.go func (p *Pool) retrieveWorker() (w worker) { //ä»ç¼“å­˜çš„å¯¹è±¡æ± ä¸­è·å–ä¸€ä¸ªworkerï¼Œå¯åŠ¨workeræ¥å—ä»»åŠ¡ï¼Œè¿™é‡Œå¯èƒ½ä¼šnewä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½å¤ç”¨ spawnWorker := func() { w = p.workerCache.Get().(*goWorker) w.run() } //åŠ é”ä¿æŠ¤workerçš„è·å– p.lock.Lock() w = p.workers.detach() if w != nil { //å¦‚æœæˆåŠŸè·å–ä¸€ä¸ªworkerï¼Œç›´æ¥è¿”å› p.lock.Unlock() } else if capacity := p.Cap(); capacity == -1 || capacity \u003e p.Running() { //å¦‚æœåˆå§‹åŒ–æ˜¯æœªé™åˆ¶workerçš„æ•°é‡ï¼Œæˆ–è€…å½“å‰åœ¨è¿è¡Œçš„workeræ•°é‡è¿˜æ²¡åˆ°è¾¾é™åˆ¶ã€‚å°±è°ƒç”¨spawnWorkerè·å–ä¸€ä¸ª p.lock.Unlock() spawnWorker() } else { //å¦åˆ™è¯æ˜workerå·²ç»ä½¿ç”¨å®Œäº†ã€‚å¦‚æœç”¨æˆ·è®¾ç½®äº†ä¸é˜»å¡ï¼Œå°±ç›´æ¥è¿”å›nilï¼Œè¿”å›é”™è¯¯ç»™ç”¨æˆ· if p.options.Nonblocking { p.lock.Unlock() return } retry: //ç­‰å¾…ç©ºé—²çš„workeré‡Šæ”¾ï¼Œå¦‚æœç­‰å¾…çš„ä»»åŠ¡è¶…å‡ºé™åˆ¶ï¼Œç›´æ¥è¿”å› if p.options.MaxBlockingTasks != 0 \u0026\u0026 p.Waiting() \u003e= p.options.MaxBlockingTasks { p.lock.Unlock() return } //condæ˜¯å®ç°çš„æŒ‡æ•°é€€é¿çš„è‡ªæ—‹é”ã€‚è‡ªæ—‹ç­‰å¾…workeré‡Šæ”¾ p.addWaiting(1) p.cond.Wait() p.addWaiting(-1) //æœ‰workerå¯ç”¨æˆ–è€…æ˜¯poolå…³é—­äº†ï¼Œå…³é—­ç›´æ¥è¿”å› if p.IsClosed() { p.lock.Unlock() return } //workå¯èƒ½è¢«å…¶ä»–ç­‰å¾…çš„ä»»åŠ¡è·å–äº†ï¼Œå¦‚æœè¿˜æœªåˆ°è¾¾å®¹é‡ä¸Šé™ï¼Œå°±ä»å¯¹è±¡æ± æ‹¿ä¸€ä¸ª //å¦åˆ™é‡è¯•ç»§ç»­è·å– if w = p.workers.detach(); w == nil { if p.Free() \u003e 0 { p.lock.Unlock() spawnWorker() return } goto retry } p.lock.Unlock() } //æˆåŠŸè·å–ï¼Œè¿”å› return } //https://github.com/panjf2000/ants/blob/dev/worker.go func (w *goWorker) inputFunc(fn func()) { //å°†ä»»åŠ¡ä¸¢ç»™chanï¼Œä¼šæœ‰workerå»æ‰§è¡Œ w.task \u003c- fn } func (w *goWorker) run() { w.pool.addRunning(1) go func() { //PanicHandlerå¯ä»¥è®¾ç½®å›è°ƒå‡½æ•°ï¼Œgowoker panicçš„æ—¶å€™å¯ä»¥åšäº›æªæ–½ defer func() { w.pool.addRunning(-1) w.pool.workerCache.Put(w) if p := recover(); p != nil { if ph := w.pool.options.PanicHandler; ph != nil { ph(p) } else { w.pool.options.Logger.Printf(\"worker exits from panic: %v\\n%s\\n\", p, debug.Stack()) } } // Call Signal() here in case there are goroutines waiting for available workers. w.pool.cond.Signal() }() //æ¯ä¸€ä¸ªgoworkeréƒ½ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ä»chanä¸­è¯»å–ä»»åŠ¡æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆåå°†å°è¯•å°†workeræ”¾åˆ°poolçš„é˜Ÿåˆ—ä¸­ã€‚ //å¦‚æœæ”¾å…¥å¤±è´¥ï¼Œè¯æ˜åç¨‹æ± ä¸­å¯è¿è¡Œåç¨‹æ•°å·²æ»¡ or å½“å‰åç¨‹æ± å·²ç»å…³é—­ï¼Œé€€å‡ºå½“å‰goroutineï¼Œå°†goworkeræ”¾åˆ°ç¼“å­˜ä¸­ã€‚ //å¦‚æœæˆåŠŸçš„è¯ï¼Œè¯æ˜å½“å‰åç¨‹æ± æ²¡æ»¡ä¹Ÿæ²¡å…³é—­ï¼Œé‚£è¿™ä¸ªåç¨‹å°±ä¼šé˜»å¡åœ¨task chanä¸Šè¯»å–ä»»åŠ¡ï¼Œæ­¤æ—¶è¿™ä¸ªåç¨‹æ˜¯æ²¡æœ‰é€€å‡ºçš„ //goworkerå¯¹è±¡è¿›å…¥workeré˜Ÿåˆ—ï¼Œç­‰å¾…æ–°ä»»åŠ¡è°ƒåº¦ï¼Œæœ‰æ–°çš„ä»»åŠ¡æ¥æ—¶ï¼Œç­‰è°ƒåº¦åˆ°goworkerï¼Œç„¶åå°†ä»»åŠ¡å†™å…¥task chan for f := range w.task { if f == nil { return } f() if ok := w.pool.revertWorker(w); !ok { return } } }() } //å°è¯•å°†goworkeræ”¾åˆ°wokeré˜Ÿåˆ—ä¸­ç®¡ç† func (p *Pool) revertWorker(worker *goWorker) bool { //å¦‚æœæ± å­ä¸­è¿è¡Œçš„workerå·²ç»å¤§äºæœ€å¤§å®¹é‡ï¼Œæˆ–è€…æ± å­å·²ç»å…³é—­ã€‚è¿”å›æ”¾å…¥å¤±è´¥ if capacity := p.Cap(); (capacity \u003e 0 \u0026\u0026 p.Running() \u003e capacity) || p.IsClosed() { //è¿™é‡Œçš„broadcastæˆ‘æŸ¥äº†èµ„æ–™ï¼Œæ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„åŸå› ï¼Œä¸ºä»€ä¹ˆæ”¾å…¥å¤±è´¥éœ€è¦å”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹ã€‚ //æˆ‘ä¸ªäººçš„ç†è§£æ˜¯ï¼Œå”¤é†’retrieveWorkerä¸­æ‰€æœ‰é˜»å¡åœ¨p.cond.wait()çš„åç¨‹ï¼Œå‡½æ•°ä¸­ä¼šåœ¨retryæ—¶é‡æ–°æ‰§è¡Œ //ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ˜¯å¦è¶…è¿‡ç”¨æˆ·è®¾ç½®çš„MaxBlockingTasksçš„é€»è¾‘ã€‚ p.cond.Broadcast() return false } //æ›´æ–°æ­¤workerä½¿ç”¨æ—¶é—´ worker.lastUsed = p.nowTime() p.lock.Lock() // è¿™é‡Œä¸ºäº†é¿å…å†…å­˜æ³„æ¼ï¼ŒäºŒæ¬¡æ£€æŸ¥æ± çš„çŠ¶æ€ã€‚å…·ä½“æ³„æ¼åœºæ™¯å¤§å®¶å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„issue // Issue: https://github.com/panjf2000/ants/issues/113 if p.IsClosed() { p.lock.Unlock() return false } //è°ƒç”¨worker queueçš„æ–¹æ³•ï¼Œå°†workeræ”¾å…¥é˜Ÿåˆ—ç®¡ç† if err := p.workers.insert(worker); err != nil { p.lock.Unlock() return false } //é€šçŸ¥æ‰€æœ‰é˜»å¡åœ¨'retrieveWorker()' æ–¹æ³•çš„åç¨‹ï¼Œæœ‰æ–°çš„workerå¯ç”¨ p.cond.Signal() p.lock.Unlock() return true } æ•´ä¸ªæµç¨‹æ¯”è¾ƒç®€å•ï¼Œè°ƒç”¨submitå‡½æ•°æäº¤è‡ªå®šä¹‰çš„ä»»åŠ¡ç»™åç¨‹æ± ï¼Œsubmitè°ƒç”¨retrieveWorkerè·å–ä¸€ä¸ªå¯ç”¨çš„workerï¼Œç„¶ååœ¨è°ƒç”¨inputFuncå‡½æ•°å°†ä»»åŠ¡äº¤ç»™è¿™ä¸ªworkerå»æ‰§è¡Œã€‚æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸‹ï¼ŒworkerCacheä½¿ç”¨äº†å¯¹è±¡æ± ï¼Œç¼“å­˜äº†goworkerå¯¹è±¡ï¼Œä»æ± ä¸­Getæ—¶ï¼Œå¯èƒ½ä¼šnewä¸€ä¸ªwoker(ç¨‹åºåˆšå¯åŠ¨æ—¶ï¼Œè¿˜æœªåˆ°è¾¾capé™åˆ¶)ï¼Œä¹Ÿå¯èƒ½ä¼šè¯»å–ä½¿ç”¨è¿‡çš„gowokerã€‚è¿˜æœ‰å°±æ˜¯ä½¿ç”¨äº†è‡ªæ—‹é”sync.Condç­‰å¾…å¯ç”¨çš„workerã€‚è¿˜æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„æ˜¯goworkerçš„runå‡½æ•°ï¼Œæ¯ä¸€ä¸ªgoworkeréƒ½ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ä»chanä¸­è¯»å–ä»»åŠ¡æ¥æ‰§è¡Œã€‚æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œéƒ½ä¼šå°è¯•å°†æ­¤workeré‡æ–°æ”¾å…¥poolçš„é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å†æ¬¡è°ƒåº¦ã€‚å¦‚æœæ”¾å…¥å¤±è´¥ï¼Œå°±ä¼šæ”¾åˆ°workerCacheå¯¹è±¡æ± ï¼Œæœ€å¤§ç¨‹åº¦å¤ç”¨å¯¹è±¡ã€‚\nä¸Šé¢å°±æ˜¯æ•´ä¸ªworkerè°ƒç”¨å’Œåˆ†é…çš„çš„æµç¨‹ï¼Œæ•´ä½“é€»è¾‘ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ³¨æ„ã€‚ä¸‹é¢é¡ºç€ä¸Šé¢çš„é€»è¾‘ï¼Œæˆ‘ä»¬ä»‹ç»ä¸‹worker_queue\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 //https://github.com/panjf2000/ants/blob/dev/worker_queue.go type worker interface { run() finish() lastUsedTime() time.Time inputFunc(func()) inputParam(interface{}) } type workerQueue interface { len() int isEmpty() bool insert(worker) error detach() worker refresh(duration time.Duration) []worker reset() } type queueType int const ( queueTypeStack queueType = 1 \u003c\u003c iota queueTypeLoopQueue ) func newWorkerQueue(qType queueType, size int) workerQueue { switch qType { case queueTypeStack: return newWorkerStack(size) case queueTypeLoopQueue: return newWorkerLoopQueue(size) default: return newWorkerStack(size) } Poolå¯¹è±¡ä¸­æœ‰workers workerQueueå¯¹è±¡ï¼ŒworkerQueueç®¡ç†æ‰€æœ‰çš„workerï¼Œæ ¹æ®newWorkerQueueæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°workerQueueæœ‰ä¸¤ç§å®ç°ï¼ŒloopQueueå®ç°äº†ring queueï¼Œåº•å±‚æ˜¯sliceæ•°ç»„åŠ ä¸€äº›å¤´å°¾æ ‡è¯†æ¥å®ç°ï¼Œä¼šé¢„å…ˆåˆ†é…sliceçš„å¤§å°ã€‚stackåº•å±‚ä¹Ÿæ˜¯sliceï¼Œé»˜è®¤å¤§å°æ˜¯0ï¼Œæ’å…¥workeræ—¶ï¼Œåº•å±‚è‡ªåŠ¨æ‰©å®¹ã€‚é™¤äº†ä¸åŒçš„ç®¡ç†é˜Ÿåˆ—å®ç°å¤–ã€‚ä¹Ÿå®šä¹‰workerå’Œqueueéœ€è¦çš„ä¸€äº›èƒ½åŠ›ã€‚å¦‚æœå¯ä»¥çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªqueueç”¨æ¥ç®¡ç†workerã€‚\nä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸‹åˆå§‹åŒ–poolæ—¶çš„é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 //https://github.com/panjf2000/ants/blob/dev/pool.go func NewPool(size int, options ...Option) (*Pool, error) { //åç¨‹æ± æ²¡æœ‰é™åˆ¶å¤§å° if size \u003c= 0 { size = -1 } opts := loadOptions(options...) //é…ç½®æ˜¯å¦éœ€è¦æ¸…ç†workerçš„åŠŸèƒ½ if !opts.DisablePurge { if expiry := opts.ExpiryDuration; expiry \u003c 0 { return nil, ErrInvalidPoolExpiry } else if expiry == 0 { opts.ExpiryDuration = DefaultCleanIntervalTime } } //ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰logger if opts.Logger == nil { opts.Logger = defaultLogger } //åˆå§‹åŒ–ä¸€ä¸ªpoolç»“æ„pï¼Œç„¶ååˆ›å»ºworkerçš„æ—¶å€™ä¼šä¼ å…¥è¿™ä¸ªpï¼Œæ‰€ä»¥æ‰€æœ‰çš„workeréƒ½æ˜¯å…¬ç”¨ä¸€ä¸ªpï¼Œä¸€ä¸ªåç¨‹æ± çš„ã€‚ //å…·ä½“çœ‹ä¸‹workerCache.Newæ–¹æ³•å°±å¯ä»¥æ˜ç™½ã€‚ //task chanæ˜¯æœ‰ç¼“å†²è¿˜æ˜¯æ— ç¼“å†²å–å†³äºGOMAXPROCSï¼Œå…·ä½“ä¸‹é¢ä¼šè§£é‡Š p := \u0026Pool{ capacity: int32(size), lock: syncx.NewSpinLock(), options: opts, } p.workerCache.New = func() interface{} { return \u0026goWorker{ pool: p, task: make(chan func(), workerChanCap), } } //è¿™é‡Œæ˜¯å†³å®šç®¡ç†workerçš„é˜Ÿåˆ—ä½¿ç”¨ring queueè¿˜æ˜¯stackã€‚å–å†³æ˜¯å¦éœ€è¦é¢„åˆ†é… if p.options.PreAlloc { if size == -1 { return nil, ErrInvalidPreAllocSize } p.workers = newWorkerQueue(queueTypeLoopQueue, size) } else { p.workers = newWorkerQueue(queueTypeStack, 0) } //åˆå§‹åŒ–è‡ªæ—‹é”ï¼Œæ¸…ç†ç¨‹åºå’Œæ›´æ–°used timeçš„å®šæ—¶ä»»åŠ¡ p.cond = sync.NewCond(p.lock) p.goPurge() p.goTicktock() return p, nil } //workerChanCapçš„å®¹é‡å–å†³äºæ ¸çš„æ•°é‡ï¼Œå•æ ¸æ—¶ï¼Œæˆ‘ä»¬è®¾ç½®chanä¸ºæ— ç¼“å†²ï¼Œè¿™æ ·çš„è¯åç¨‹å°±ä¼šç«‹åˆ»ä»senderè½¬åŒ–åˆ°receiverï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚ //å¤šæ ¸æ—¶ï¼Œè®¾ç½®æœ‰ç¼“å†²çš„chanï¼Œé¿å…æ¥æ”¶æ–¹æ¥å—çš„é€Ÿç‡å½±å“åˆ°å‘é€æ–¹ workerChanCap = func() int { // Use blocking channel if GOMAXPROCS=1. // This switches context from sender to receiver immediately, // which results in higher performance (under go1.5 at least). if runtime.GOMAXPROCS(0) == 1 { return 0 } // Use non-blocking workerChan if GOMAXPROCS\u003e1, // since otherwise the sender might be dragged down if the receiver is CPU-bound. return 1 }() æ‰©å±•é˜…è¯» ",
  "wordCount" : "5064",
  "inLanguage": "en",
  "datePublished": "2023-03-13T16:40:32+08:00",
  "dateModified": "2023-03-13T16:40:32+08:00",
  "author":[{
    "@type": "Person",
    "name": "Younger"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://younger027.github.io/en/posts/tech/go-ants/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Younger's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://youngergo.cn/images/life/me/avatar.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://younger027.github.io/en/" accesskey="h" title="Younger&#39;s Blog (Alt + H)">
                <img src="https://youngergo.cn/images/life/me/avatar.jpg" alt="" aria-label="logo"
                    height="35">Younger&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://younger027.github.io/en/">Home</a>&nbsp;Â»&nbsp;<a href="https://younger027.github.io/en/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://younger027.github.io/en/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Go Ants
    </h1>
    <div class="post-meta"><span title='2023-03-13 16:40:32 +0800 CST'>2023-03-13</span>&nbsp;Â·&nbsp;11 min&nbsp;Â·&nbsp;Younger

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b" aria-label="ç®€ä»‹">ç®€ä»‹</a></li>
                <li>
                    <a href="#%e8%ae%be%e8%ae%a1%e7%90%86%e5%bf%b5" aria-label="è®¾è®¡ç†å¿µ">è®¾è®¡ç†å¿µ</a></li>
                <li>
                    <a href="#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84" aria-label="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</a></li>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90" aria-label="æºç è§£æ">æºç è§£æ</a></li>
                <li>
                    <a href="#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb" aria-label="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="ç®€ä»‹">ç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#ç®€ä»‹">#</a></h3>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangçš„goroutineæ˜¯goå¹¶å‘ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ç®€å•go func()å°±å¯ä»¥å¼€å¯ä¸€ä¸ªgoåç¨‹ï¼Œç„¶åè°ƒåº¦å™¨ä¼šç®¡ç†goåç¨‹åˆ†é…ç›¸åº”çš„På’ŒMï¼Œæ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸”å¼€å¯ä¸€ä¸ªgoroutineä»£ä»·å¾ˆå°ï¼Œåªä¼šå ç”¨2kçš„æ ˆç©ºé—´ã€‚ä½†æ˜¯åç¨‹ä¹Ÿä¸æ˜¯éšæ„æƒ³å¼€å¤šå°‘å°±å¤šå°‘ï¼Œè¿‡å¤šçš„goroutineä¸ä»…ä¼šå½±å“è°ƒåº¦å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œä¹Ÿä¼šé€ æˆå†…å­˜çš„å¿«é€Ÿå¢é•¿ã€‚</p>
<p>ä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªgithubä¸Šæœ‰1w starçš„åç¨‹æ± åº“<a href="https://github.com/panjf2000/ants">ants</a>ã€‚&ldquo;antsæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ goroutine æ± ï¼Œå®ç°äº†å¯¹å¤§è§„æ¨¡ goroutine çš„è°ƒåº¦ç®¡ç†ã€goroutine å¤ç”¨ï¼Œå…è®¸ä½¿ç”¨è€…åœ¨å¼€å‘å¹¶å‘ç¨‹åºçš„æ—¶å€™é™åˆ¶ goroutine æ•°é‡ï¼Œå¤ç”¨èµ„æºï¼Œè¾¾åˆ°æ›´é«˜æ•ˆæ‰§è¡Œä»»åŠ¡çš„æ•ˆæœã€‚ä»benchmarkçš„ç»“æœæ¥çœ‹ï¼Œä½¿ç”¨antsçš„ååæ€§èƒ½ç›¸è¾ƒäºåŸç”Ÿ goroutine å¯ä»¥ä¿æŒåœ¨ 2-6 å€çš„æ€§èƒ½å‹åˆ¶ï¼Œè€Œå†…å­˜æ¶ˆè€—åˆ™å¯ä»¥è¾¾åˆ° 10-20 å€çš„èŠ‚çœä¼˜åŠ¿&rdquo;(æ¥è‡ªä»“åº“æè¿°)ï¼Œå…·ä½“çš„ç»†èŠ‚å¯ä»¥çœ‹gitä»“åº“ã€‚</p>
<h3 id="è®¾è®¡ç†å¿µ">è®¾è®¡ç†å¿µ<a hidden class="anchor" aria-hidden="true" href="#è®¾è®¡ç†å¿µ">#</a></h3>
<p>antsçš„è®¾è®¡ç†å¿µæ˜¯ä½¿ç”¨Nä¸ªwork goroutine å®ŒæˆMä¸ªtaskçš„æ‰§è¡Œã€‚æ§åˆ¶goroutineçš„æ•°é‡ã€‚å°±åƒä»“åº“ä¸­çš„Activity Diagramsæè¿°çš„é‚£æ ·ã€‚ä½†æ˜¯è¿™æ ·çš„è®¾è®¡ä¹Ÿä¼šæœ‰ä¸€äº›å¼Šç«¯ï¼Œæˆ‘ä»¬åé¢å†èŠã€‚<img loading="lazy" src="https://raw.githubusercontent.com/panjf2000/illustrations/master/go/ants-pool-2.png" alt="antsè®¾è®¡ç†å¿µ"  />
</p>
<h3 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#ç›®å½•ç»“æ„">#</a></h3>
<p>antsçš„ä»£ç å¹¶ä¸å¤šï¼Œé™¤äº†testå¤–æ€»å…±ä¹Ÿåªæœ‰åå¤šä¸ªæ–‡ä»¶ï¼Œè€Œä¸”ä»£ç è¡Œæ•°ä¹Ÿä¸å¤šï¼Œä¸‹é¢æ˜¯æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li>ants.go
<ul>
<li>ants.go å°è£…äº†å¤–éƒ¨è°ƒç”¨çš„èƒ½åŠ›ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€ä¸ªæ—  goroutine é™åˆ¶çš„defaultAntsPoolå¯¹è±¡ï¼Œæä¾›äº†ä»»åŠ¡æäº¤ï¼Œè·å–è¿è¡Œåç¨‹æ•°é‡ï¼Œè·å–å®¹é‡ç­‰èƒ½åŠ›ã€‚</li>
</ul>
</li>
<li>pool.go
<ul>
<li>pool.go å®ç°åç¨‹æ± éœ€è¦çš„èƒ½åŠ›ã€‚åç¨‹æ± çš„å®šä¹‰ï¼Œä»»åŠ¡æäº¤ï¼Œåˆ†é…åç¨‹ç­‰é€»è¾‘å®ç°ï¼Œéƒ½åœ¨è¿™æ–‡ä»¶ä¸­ï¼Œantsä¸­çš„defaultAntsPoolè°ƒç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„å®ç°ã€‚</li>
</ul>
</li>
<li>pool_func.go
<ul>
<li>pool_func.go å’Œpool.goåšçš„äº‹æƒ…å·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºpool.goå¯ä»¥æ‰§è¡Œä¸åŒçš„åç¨‹ä»»åŠ¡ï¼Œpool_func.go æ‰§è¡Œçš„æ˜¯ç›¸åŒçš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥ä¼ ä¸åŒçš„å‚æ•°ã€‚ä½¿ç”¨åœºæ™¯ä¸åŒã€‚</li>
</ul>
</li>
<li>work.go
<ul>
<li>work.go å®Œæˆå…·ä½“ä»»åŠ¡çš„æ‰§è¡ŒgoWorkï¼Œå®ä¾‹åŒ–äº†work_queue.goä¸­worker interfaceçš„å®ç°ã€‚å’Œpool.goå…³è”ã€‚</li>
</ul>
</li>
<li>work_func.go
<ul>
<li>work_func.go å’Œwork.goçš„åšäº†åŒæ ·çš„äº‹æƒ…ï¼Œå®ƒå’Œpool_func.goå…³è”ã€‚</li>
</ul>
</li>
<li>worker_queue.go
<ul>
<li>worker_queue.go worker_queueæ˜¯ç®¡ç†workeræ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå®šä¹‰äº†worker å’Œworker queueéœ€è¦å®ç°çš„èƒ½åŠ›ã€‚</li>
</ul>
</li>
<li>worker_loop_queue.go
<ul>
<li>worker_loop_queue.go ç”¨é˜Ÿåˆ—çš„å½¢å¼å®ç°å¯¹wokeré˜Ÿåˆ—çš„ç®¡ç†ã€‚</li>
</ul>
</li>
<li>worker_stack.go
<ul>
<li>worker_stack.go  ä»¥æ ˆçš„å½¢å¼å®ç°workeré˜Ÿåˆ—ç®¡ç†</li>
</ul>
</li>
<li>options.go
<ul>
<li>options.go antså¯¹è±¡çš„ä¸€äº›é…ç½®ç‰¹æ€§</li>
</ul>
</li>
</ul>
<p>è¿™äº›å°±æ˜¯antsçš„ä¸»è¦æ–‡ä»¶ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¾ˆç®€å•ï¼ŒworkerQueue interfaceå®šä¹‰äº†workeré˜Ÿåˆ—çš„èƒ½åŠ›ï¼Œæœ‰ring queueå’Œstackä¸¤ç§å®ç°ã€‚woker interfaceå®šä¹‰äº†workçš„èƒ½åŠ›ï¼Œæœ‰workå’Œwork_funcä¸¤ç§å®ç°ã€‚åç¨‹æ± ä¹Ÿå°±æœ‰å¯¹åº”poolå’Œpool_funcä¸¤ç§å®ç°ã€‚</p>
<h3 id="æºç è§£æ">æºç è§£æ<a hidden class="anchor" aria-hidden="true" href="#æºç è§£æ">#</a></h3>
<p>antsçš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚ï¼Œå®ƒå®ç°äº†ä¸¤ç§èƒ½åŠ›çš„åç¨‹æ± ï¼Œpoolæ˜¯å¯ä»¥æ‰§è¡Œä¸åŒä»»åŠ¡çš„åç¨‹æ± ï¼ŒpoolWithFuncåªèƒ½æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ï¼Œä½†æ˜¯å‚æ•°å¯ä»¥ä¸åŒã€‚å¯¹åº”æ­¤ä¸¤ç§èƒ½åŠ›ï¼Œæ‰€ä»¥æœ‰äº†goWorkerå’ŒgoWokerWithFuncä¸¤ç§workerã€‚æˆ‘ä»¬å…ˆä»‹ç»poolç›¸å…³æºç (poolå…³è”work.goä¸­çš„goWorker)ï¼Œå¤§å®¶å¯ä»¥å¯¹ç…§é˜…è¯»poolWithFuncçš„ä»£ç ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆä»exampleå…¥æ‰‹ï¼š(ä¸€èˆ¬å¼€æºçš„ä»£ç éƒ½ä¼šæœ‰exampleæ–‡ä»¶ï¼Œæˆ‘ä»¬å­¦ä¹ ä¹‹å‰å¯ä»¥å…ˆä»è¿™äº›ç¤ºä¾‹å…¥æ‰‹ï¼Œç„¶åé’ˆå¯¹æ„Ÿå…´è¶£çš„æ¨¡å—é€å±‚æ·±å…¥ï¼Œè¿™æ ·æ•ˆç‡ä¼šé«˜ç‚¹)</p>
<div class="highlight line-number"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/examples/main.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/panjf2000/ants/v2&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sum</span> <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">i</span>.(<span style="color:#66d9ef">int32</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sum</span>, <span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;run with %d\n&#34;</span>, <span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoFunc</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Hello World!&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Release</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">runTimes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Use the common pool.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">syncCalculateSum</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">demoFunc</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Submit</span>(<span style="color:#a6e22e">syncCalculateSum</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">Running</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks.\n&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Use the pool with a method,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// set 10 to the capacity of goroutine pool and 1 second for expired duration.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ants</span>.<span style="color:#a6e22e">NewPoolWithFunc</span>(<span style="color:#ae81ff">10</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">myFunc</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Release</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Submit tasks one by one.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">runTimes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Invoke</span>(int32(<span style="color:#a6e22e">i</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;running goroutines: %d\n&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Running</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;finish all tasks, result is %d\n&#34;</span>, <span style="color:#a6e22e">sum</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sum</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">499500</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#e6db74">&#34;the final result is wrong!!!&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æµ‹è¯•ä»£ç ä»‹ç»äº†poolå’ŒpoolWithFuncçš„ä½¿ç”¨ã€‚syncCalculateSumå‡½æ•°å°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œants.Submit(syncCalculateSum)å°†ä»»åŠ¡æäº¤åˆ°poolä¸­ï¼Œç„¶åä¼šåˆ†é…ç»™workå»æ‰§è¡Œã€‚é‚£ä¹ˆæˆ‘ä»¬å»çœ‹çœ‹Submitå…·ä½“å®ç°</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//é¦–å…ˆå…ˆäº†è§£ä¸‹goWorkerçš„å®šä¹‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/work.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">goWorker</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åç¨‹æ± å¯¹è±¡ï¼Œå…¶å®å¤šä¸ªgoWorkerå…±äº«çš„æ˜¯ä¸€ä¸ªpoolå¯¹è±¡ï¼Œåœ¨åˆ›å»ºworkeræ˜¯ä¼ çš„åŒä¸€ä¸ªpï¼Œä¸‹é¢ä»£ç ä¼šè®²ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pool</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ¥å—ä»»åŠ¡çš„æœ‰ç¼“å†²çš„chan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">task</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">func</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´ï¼Œä¸»è¦æ˜¯æ¸…ç†workeræ—¶ä½¿ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lastUsed</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/pool.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Pool</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åç¨‹æ± çš„å®¹é‡ï¼Œè´Ÿæ•°ä»£è¡¨æ— é™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">capacity</span> <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//å½“å‰åœ¨è¿è¡Œçš„workeræ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">running</span> <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ä¿æŠ¤ä»é˜Ÿåˆ—ä¸­è¯»å†™worker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Locker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// workersé˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—æœ‰stackå’Œring queueä¸¤ç§å®ç°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">workers</span> <span style="color:#a6e22e">workerQueue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//åç¨‹æ± çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">state</span> <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//è‡ªæ—‹é”ï¼Œç­‰å¾…è·å–ç©ºé—²çš„worker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cond</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// workerCache ä½¿ç”¨å¯¹è±¡æ± ï¼ŒåŠ å¿«äº†åœ¨ function:retrieveWorker ä¸­è·å–å¯ç”¨ Worker çš„é€Ÿåº¦ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">workerCache</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// é˜»å¡åœ¨condä¸Šçš„ä»»åŠ¡æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">waiting</span> <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//æ¸…ç†ç­‰å¾…æ—¶é—´è¿‡é•¿çš„worker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">purgeDone</span> <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stopPurge</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">CancelFunc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//æ›´æ–°workerçš„ä½¿ç”¨æ—¶é—´ï¼Œä¹Ÿæ˜¯ç”¨äºæ¸…ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ticktockDone</span> <span style="color:#66d9ef">int32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stopTicktock</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">CancelFunc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//ä½¿ç”¨æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">now</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//é…ç½®ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">options</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Options</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/pool.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Submit</span>(<span style="color:#a6e22e">task</span> <span style="color:#66d9ef">func</span>()) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//åˆ¤æ–­åç¨‹æ± æ˜¯å¦å…³é—­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">IsClosed</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPoolClosed</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//æ£€ç´¢å‡ºä¸€ä¸ªå¯ç”¨çš„workï¼Œç„¶åå°†ä»»åŠ¡äº¤ç»™workå»æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">w</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">retrieveWorker</span>(); <span style="color:#a6e22e">w</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">inputFunc</span>(<span style="color:#a6e22e">task</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrPoolOverload</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/pool.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">retrieveWorker</span>() (<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">worker</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//ä»ç¼“å­˜çš„å¯¹è±¡æ± ä¸­è·å–ä¸€ä¸ªworkerï¼Œå¯åŠ¨workeræ¥å—ä»»åŠ¡ï¼Œè¿™é‡Œå¯èƒ½ä¼šnewä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½å¤ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">spawnWorker</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">workerCache</span>.<span style="color:#a6e22e">Get</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">goWorker</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">run</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//åŠ é”ä¿æŠ¤workerçš„è·å–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">workers</span>.<span style="color:#a6e22e">detach</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">w</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//å¦‚æœæˆåŠŸè·å–ä¸€ä¸ªworkerï¼Œç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">capacity</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Cap</span>(); <span style="color:#a6e22e">capacity</span> <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">capacity</span> &gt; <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Running</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//å¦‚æœåˆå§‹åŒ–æ˜¯æœªé™åˆ¶workerçš„æ•°é‡ï¼Œæˆ–è€…å½“å‰åœ¨è¿è¡Œçš„workeræ•°é‡è¿˜æ²¡åˆ°è¾¾é™åˆ¶ã€‚å°±è°ƒç”¨spawnWorkerè·å–ä¸€ä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">spawnWorker</span>()
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">//å¦åˆ™è¯æ˜workerå·²ç»ä½¿ç”¨å®Œäº†ã€‚å¦‚æœç”¨æˆ·è®¾ç½®äº†ä¸é˜»å¡ï¼Œå°±ç›´æ¥è¿”å›nilï¼Œè¿”å›é”™è¯¯ç»™ç”¨æˆ·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">Nonblocking</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">retry</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//ç­‰å¾…ç©ºé—²çš„workeré‡Šæ”¾ï¼Œå¦‚æœç­‰å¾…çš„ä»»åŠ¡è¶…å‡ºé™åˆ¶ï¼Œç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">MaxBlockingTasks</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Waiting</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">MaxBlockingTasks</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//condæ˜¯å®ç°çš„æŒ‡æ•°é€€é¿çš„è‡ªæ—‹é”ã€‚è‡ªæ—‹ç­‰å¾…workeré‡Šæ”¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">addWaiting</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">addWaiting</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//æœ‰workerå¯ç”¨æˆ–è€…æ˜¯poolå…³é—­äº†ï¼Œå…³é—­ç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">IsClosed</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//workå¯èƒ½è¢«å…¶ä»–ç­‰å¾…çš„ä»»åŠ¡è·å–äº†ï¼Œå¦‚æœè¿˜æœªåˆ°è¾¾å®¹é‡ä¸Šé™ï¼Œå°±ä»å¯¹è±¡æ± æ‹¿ä¸€ä¸ª
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//å¦åˆ™é‡è¯•ç»§ç»­è·å–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">w</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">workers</span>.<span style="color:#a6e22e">detach</span>(); <span style="color:#a6e22e">w</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Free</span>() &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">spawnWorker</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">retry</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//æˆåŠŸè·å–ï¼Œè¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/worker.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">goWorker</span>) <span style="color:#a6e22e">inputFunc</span>(<span style="color:#a6e22e">fn</span> <span style="color:#66d9ef">func</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//å°†ä»»åŠ¡ä¸¢ç»™chanï¼Œä¼šæœ‰workerå»æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">task</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">fn</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">goWorker</span>) <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">addRunning</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//PanicHandlerå¯ä»¥è®¾ç½®å›è°ƒå‡½æ•°ï¼Œgowoker panicçš„æ—¶å€™å¯ä»¥åšäº›æªæ–½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">addRunning</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">workerCache</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">w</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">p</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ph</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">PanicHandler</span>; <span style="color:#a6e22e">ph</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">ph</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>				} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;worker exits from panic: %v\n%s\n&#34;</span>, <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">debug</span>.<span style="color:#a6e22e">Stack</span>())
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Call Signal() here in case there are goroutines waiting for available workers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Signal</span>()
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//æ¯ä¸€ä¸ªgoworkeréƒ½ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ä»chanä¸­è¯»å–ä»»åŠ¡æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆåå°†å°è¯•å°†workeræ”¾åˆ°poolçš„é˜Ÿåˆ—ä¸­ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//å¦‚æœæ”¾å…¥å¤±è´¥ï¼Œè¯æ˜åç¨‹æ± ä¸­å¯è¿è¡Œåç¨‹æ•°å·²æ»¡ or å½“å‰åç¨‹æ± å·²ç»å…³é—­ï¼Œé€€å‡ºå½“å‰goroutineï¼Œå°†goworkeræ”¾åˆ°ç¼“å­˜ä¸­ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//å¦‚æœæˆåŠŸçš„è¯ï¼Œè¯æ˜å½“å‰åç¨‹æ± æ²¡æ»¡ä¹Ÿæ²¡å…³é—­ï¼Œé‚£è¿™ä¸ªåç¨‹å°±ä¼šé˜»å¡åœ¨task chanä¸Šè¯»å–ä»»åŠ¡ï¼Œæ­¤æ—¶è¿™ä¸ªåç¨‹æ˜¯æ²¡æœ‰é€€å‡ºçš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//goworkerå¯¹è±¡è¿›å…¥workeré˜Ÿåˆ—ï¼Œç­‰å¾…æ–°ä»»åŠ¡è°ƒåº¦ï¼Œæœ‰æ–°çš„ä»»åŠ¡æ¥æ—¶ï¼Œç­‰è°ƒåº¦åˆ°goworkerï¼Œç„¶åå°†ä»»åŠ¡å†™å…¥task chan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">task</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">f</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">revertWorker</span>(<span style="color:#a6e22e">w</span>); !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//å°è¯•å°†goworkeræ”¾åˆ°wokeré˜Ÿåˆ—ä¸­ç®¡ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">revertWorker</span>(<span style="color:#a6e22e">worker</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">goWorker</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//å¦‚æœæ± å­ä¸­è¿è¡Œçš„workerå·²ç»å¤§äºæœ€å¤§å®¹é‡ï¼Œæˆ–è€…æ± å­å·²ç»å…³é—­ã€‚è¿”å›æ”¾å…¥å¤±è´¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">capacity</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Cap</span>(); (<span style="color:#a6e22e">capacity</span> &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Running</span>() &gt; <span style="color:#a6e22e">capacity</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">IsClosed</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//è¿™é‡Œçš„broadcastæˆ‘æŸ¥äº†èµ„æ–™ï¼Œæ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„åŸå› ï¼Œä¸ºä»€ä¹ˆæ”¾å…¥å¤±è´¥éœ€è¦å”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//æˆ‘ä¸ªäººçš„ç†è§£æ˜¯ï¼Œå”¤é†’retrieveWorkerä¸­æ‰€æœ‰é˜»å¡åœ¨p.cond.wait()çš„åç¨‹ï¼Œå‡½æ•°ä¸­ä¼šåœ¨retryæ—¶é‡æ–°æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ˜¯å¦è¶…è¿‡ç”¨æˆ·è®¾ç½®çš„MaxBlockingTasksçš„é€»è¾‘ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Broadcast</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//æ›´æ–°æ­¤workerä½¿ç”¨æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">worker</span>.<span style="color:#a6e22e">lastUsed</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">nowTime</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¿™é‡Œä¸ºäº†é¿å…å†…å­˜æ³„æ¼ï¼ŒäºŒæ¬¡æ£€æŸ¥æ± çš„çŠ¶æ€ã€‚å…·ä½“æ³„æ¼åœºæ™¯å¤§å®¶å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„issue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Issue: https://github.com/panjf2000/ants/issues/113
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">IsClosed</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//è°ƒç”¨worker queueçš„æ–¹æ³•ï¼Œå°†workeræ”¾å…¥é˜Ÿåˆ—ç®¡ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">workers</span>.<span style="color:#a6e22e">insert</span>(<span style="color:#a6e22e">worker</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//é€šçŸ¥æ‰€æœ‰é˜»å¡åœ¨&#39;retrieveWorker()&#39; æ–¹æ³•çš„åç¨‹ï¼Œæœ‰æ–°çš„workerå¯ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Signal</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•´ä¸ªæµç¨‹æ¯”è¾ƒç®€å•ï¼Œè°ƒç”¨submitå‡½æ•°æäº¤è‡ªå®šä¹‰çš„ä»»åŠ¡ç»™åç¨‹æ± ï¼Œsubmitè°ƒç”¨retrieveWorkerè·å–ä¸€ä¸ªå¯ç”¨çš„workerï¼Œç„¶ååœ¨è°ƒç”¨inputFuncå‡½æ•°å°†ä»»åŠ¡äº¤ç»™è¿™ä¸ªworkerå»æ‰§è¡Œã€‚æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸‹ï¼ŒworkerCacheä½¿ç”¨äº†å¯¹è±¡æ± ï¼Œç¼“å­˜äº†goworkerå¯¹è±¡ï¼Œä»æ± ä¸­Getæ—¶ï¼Œå¯èƒ½ä¼šnewä¸€ä¸ªwoker(ç¨‹åºåˆšå¯åŠ¨æ—¶ï¼Œè¿˜æœªåˆ°è¾¾capé™åˆ¶)ï¼Œä¹Ÿå¯èƒ½ä¼šè¯»å–ä½¿ç”¨è¿‡çš„gowokerã€‚è¿˜æœ‰å°±æ˜¯ä½¿ç”¨äº†è‡ªæ—‹é”sync.Condç­‰å¾…å¯ç”¨çš„workerã€‚è¿˜æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„æ˜¯goworkerçš„runå‡½æ•°ï¼Œæ¯ä¸€ä¸ªgoworkeréƒ½ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ä»chanä¸­è¯»å–ä»»åŠ¡æ¥æ‰§è¡Œã€‚æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œéƒ½ä¼šå°è¯•å°†æ­¤workeré‡æ–°æ”¾å…¥poolçš„é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å†æ¬¡è°ƒåº¦ã€‚å¦‚æœæ”¾å…¥å¤±è´¥ï¼Œå°±ä¼šæ”¾åˆ°workerCacheå¯¹è±¡æ± ï¼Œæœ€å¤§ç¨‹åº¦å¤ç”¨å¯¹è±¡ã€‚</p>
<p>ä¸Šé¢å°±æ˜¯æ•´ä¸ªworkerè°ƒç”¨å’Œåˆ†é…çš„çš„æµç¨‹ï¼Œæ•´ä½“é€»è¾‘ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ³¨æ„ã€‚ä¸‹é¢é¡ºç€ä¸Šé¢çš„é€»è¾‘ï¼Œæˆ‘ä»¬ä»‹ç»ä¸‹worker_queue</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/worker_queue.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">worker</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">run</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">finish</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lastUsedTime</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inputFunc</span>(<span style="color:#66d9ef">func</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inputParam</span>(<span style="color:#66d9ef">interface</span>{})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">workerQueue</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	len() <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">isEmpty</span>() <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">insert</span>(<span style="color:#a6e22e">worker</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">detach</span>() <span style="color:#a6e22e">worker</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">refresh</span>(<span style="color:#a6e22e">duration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) []<span style="color:#a6e22e">worker</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reset</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">queueType</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">queueTypeStack</span> <span style="color:#a6e22e">queueType</span> = <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#66d9ef">iota</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">queueTypeLoopQueue</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newWorkerQueue</span>(<span style="color:#a6e22e">qType</span> <span style="color:#a6e22e">queueType</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">workerQueue</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">qType</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">queueTypeStack</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newWorkerStack</span>(<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">queueTypeLoopQueue</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newWorkerLoopQueue</span>(<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newWorkerStack</span>(<span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Poolå¯¹è±¡ä¸­æœ‰workers workerQueueå¯¹è±¡ï¼ŒworkerQueueç®¡ç†æ‰€æœ‰çš„workerï¼Œæ ¹æ®newWorkerQueueæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°workerQueueæœ‰ä¸¤ç§å®ç°ï¼ŒloopQueueå®ç°äº†ring queueï¼Œåº•å±‚æ˜¯sliceæ•°ç»„åŠ ä¸€äº›å¤´å°¾æ ‡è¯†æ¥å®ç°ï¼Œä¼šé¢„å…ˆåˆ†é…sliceçš„å¤§å°ã€‚stackåº•å±‚ä¹Ÿæ˜¯sliceï¼Œé»˜è®¤å¤§å°æ˜¯0ï¼Œæ’å…¥workeræ—¶ï¼Œåº•å±‚è‡ªåŠ¨æ‰©å®¹ã€‚é™¤äº†ä¸åŒçš„ç®¡ç†é˜Ÿåˆ—å®ç°å¤–ã€‚ä¹Ÿå®šä¹‰workerå’Œqueueéœ€è¦çš„ä¸€äº›èƒ½åŠ›ã€‚å¦‚æœå¯ä»¥çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªqueueç”¨æ¥ç®¡ç†workerã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸‹åˆå§‹åŒ–poolæ—¶çš„é€»è¾‘</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//https://github.com/panjf2000/ants/blob/dev/pool.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPool</span>(<span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">Option</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//åç¨‹æ± æ²¡æœ‰é™åˆ¶å¤§å°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">size</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">opts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">loadOptions</span>(<span style="color:#a6e22e">options</span><span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//é…ç½®æ˜¯å¦éœ€è¦æ¸…ç†workerçš„åŠŸèƒ½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">DisablePurge</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">expiry</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">ExpiryDuration</span>; <span style="color:#a6e22e">expiry</span> &lt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrInvalidPoolExpiry</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">expiry</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">ExpiryDuration</span> = <span style="color:#a6e22e">DefaultCleanIntervalTime</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰logger
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Logger</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">Logger</span> = <span style="color:#a6e22e">defaultLogger</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//åˆå§‹åŒ–ä¸€ä¸ªpoolç»“æ„pï¼Œç„¶ååˆ›å»ºworkerçš„æ—¶å€™ä¼šä¼ å…¥è¿™ä¸ªpï¼Œæ‰€ä»¥æ‰€æœ‰çš„workeréƒ½æ˜¯å…¬ç”¨ä¸€ä¸ªpï¼Œä¸€ä¸ªåç¨‹æ± çš„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//å…·ä½“çœ‹ä¸‹workerCache.Newæ–¹æ³•å°±å¯ä»¥æ˜ç™½ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//task chanæ˜¯æœ‰ç¼“å†²è¿˜æ˜¯æ— ç¼“å†²å–å†³äºGOMAXPROCSï¼Œå…·ä½“ä¸‹é¢ä¼šè§£é‡Š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Pool</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">capacity</span>: int32(<span style="color:#a6e22e">size</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lock</span>:     <span style="color:#a6e22e">syncx</span>.<span style="color:#a6e22e">NewSpinLock</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">options</span>:  <span style="color:#a6e22e">opts</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">workerCache</span>.<span style="color:#a6e22e">New</span> = <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">interface</span>{} {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">goWorker</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">pool</span>: <span style="color:#a6e22e">p</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">task</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">func</span>(), <span style="color:#a6e22e">workerChanCap</span>),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//è¿™é‡Œæ˜¯å†³å®šç®¡ç†workerçš„é˜Ÿåˆ—ä½¿ç”¨ring queueè¿˜æ˜¯stackã€‚å–å†³æ˜¯å¦éœ€è¦é¢„åˆ†é…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">PreAlloc</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">size</span> <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrInvalidPreAllocSize</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">workers</span> = <span style="color:#a6e22e">newWorkerQueue</span>(<span style="color:#a6e22e">queueTypeLoopQueue</span>, <span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">workers</span> = <span style="color:#a6e22e">newWorkerQueue</span>(<span style="color:#a6e22e">queueTypeStack</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//åˆå§‹åŒ–è‡ªæ—‹é”ï¼Œæ¸…ç†ç¨‹åºå’Œæ›´æ–°used timeçš„å®šæ—¶ä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span> = <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">NewCond</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">lock</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">goPurge</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">goTicktock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//workerChanCapçš„å®¹é‡å–å†³äºæ ¸çš„æ•°é‡ï¼Œå•æ ¸æ—¶ï¼Œæˆ‘ä»¬è®¾ç½®chanä¸ºæ— ç¼“å†²ï¼Œè¿™æ ·çš„è¯åç¨‹å°±ä¼šç«‹åˆ»ä»senderè½¬åŒ–åˆ°receiverï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//å¤šæ ¸æ—¶ï¼Œè®¾ç½®æœ‰ç¼“å†²çš„chanï¼Œé¿å…æ¥æ”¶æ–¹æ¥å—çš„é€Ÿç‡å½±å“åˆ°å‘é€æ–¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">workerChanCap</span> = <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Use blocking channel if GOMAXPROCS=1.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// This switches context from sender to receiver immediately,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// which results in higher performance (under go1.5 at least).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">GOMAXPROCS</span>(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Use non-blocking workerChan if GOMAXPROCS&gt;1,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// since otherwise the sender might be dragged down if the receiver is CPU-bound.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	}()
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ‰©å±•é˜…è¯»">æ‰©å±•é˜…è¯»<a hidden class="anchor" aria-hidden="true" href="#æ‰©å±•é˜…è¯»">#</a></h3>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://younger027.github.io/en/tags/golang/">golang</a></li>
      <li><a href="https://younger027.github.io/en/tags/%E6%BA%90%E7%A0%81/">æºç </a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://younger027.github.io/en/posts/tech/go-atomic/">
    <span class="title">Next Â»</span>
    <br>
    <span>Go Atomic</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://younger027.github.io/en/">Younger&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
