<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go Atomic | Younger&#39;s Blog</title>
<meta name="keywords" content="golang, æºç ">
<meta name="description" content="æºç è§£æ æºç ç‰ˆæœ¬ï¼š1.18 atomicåŒ…ä¸»è¦æ”¯æŒä¸€äº›åŸå­æ“ä½œï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æºç docæ–‡ä»¶(atomicçš„æºç è·¯å¾„ï¼š/src/runtime">
<meta name="author" content="Younger">
<link rel="canonical" href="https://younger027.github.io/en/posts/tech/go-atomic/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="apple-touch-icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<link rel="mask-icon" href="https://youngergo.cn/images/life/me/avatar.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Go Atomic" />
<meta property="og:description" content="æºç è§£æ æºç ç‰ˆæœ¬ï¼š1.18 atomicåŒ…ä¸»è¦æ”¯æŒä¸€äº›åŸå­æ“ä½œï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æºç docæ–‡ä»¶(atomicçš„æºç è·¯å¾„ï¼š/src/runtime" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://younger027.github.io/en/posts/tech/go-atomic/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-13T16:40:32+08:00" />
<meta property="article:modified_time" content="2023-03-13T16:40:32+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go Atomic"/>
<meta name="twitter:description" content="æºç è§£æ æºç ç‰ˆæœ¬ï¼š1.18 atomicåŒ…ä¸»è¦æ”¯æŒä¸€äº›åŸå­æ“ä½œï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æºç docæ–‡ä»¶(atomicçš„æºç è·¯å¾„ï¼š/src/runtime"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://younger027.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://younger027.github.io/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Go Atomic",
      "item": "https://younger027.github.io/en/posts/tech/go-atomic/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go Atomic",
  "name": "Go Atomic",
  "description": "æºç è§£æ æºç ç‰ˆæœ¬ï¼š1.18 atomicåŒ…ä¸»è¦æ”¯æŒä¸€äº›åŸå­æ“ä½œï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æºç docæ–‡ä»¶(atomicçš„æºç è·¯å¾„ï¼š/src/runtime",
  "keywords": [
    "golang", "æºç "
  ],
  "articleBody": "æºç è§£æ æºç ç‰ˆæœ¬ï¼š1.18\natomicåŒ…ä¸»è¦æ”¯æŒä¸€äº›åŸå­æ“ä½œï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æºç docæ–‡ä»¶(atomicçš„æºç è·¯å¾„ï¼š/src/runtime/internal/atomic)å¯¹atomicçš„ä»‹ç»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 /* Package atomic provides atomic operations, independent of sync/atomic, to the runtime. On most platforms, the compiler is aware of the functions defined in this package, and they're replaced with platform-specific intrinsics. On other platforms, generic implementations are made available. Unless otherwise noted, operations defined in this package are sequentially consistent across threads with respect to the Vals they manipulate. More specifically, operations that happen in a specific order on one thread, will always be observed to happen in exactly that order by another thread. */ /* åŒ…atomicæä¾›åŸå­æ“ä½œï¼Œç‹¬ç«‹äºsync/atomicã€‚å‘è¿è¡Œæ—¶æä¾›åŸå­æ“ä½œã€‚ åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œç¼–è¯‘å™¨éƒ½çŸ¥é“è¿™ä¸ªåŒ…ä¸­å®šä¹‰çš„å‡½æ•°ã€‚ åœ¨è¿™ä¸ªåŒ…ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œå®ƒä»¬è¢«æ›¿æ¢æˆç‰¹å®šå¹³å°çš„æœ¬å¾ã€‚ åœ¨å…¶ä»–å¹³å°ä¸Šï¼Œé€šç”¨çš„å®ç°æ˜¯å¯ç”¨çš„ã€‚ é™¤éå¦æœ‰è¯´æ˜ï¼Œæœ¬åŒ…ä¸­å®šä¹‰çš„æ“ä½œåœ¨é¡ºåºä¸Šæ˜¯ åœ¨å®ƒä»¬æ‰€æ“ä½œçš„å€¼æ–¹é¢ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ˜¯ä¸€è‡´çš„ã€‚æ›´å…·ä½“åœ°è¯´ å…·ä½“æ¥è¯´ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šä»¥ç‰¹å®šé¡ºåºå‘ç”Ÿçš„æ“ä½œã€‚ å°†æ€»æ˜¯è¢«å¦ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿåˆ°ä»¥è¯¥é¡ºåºå‘ç”Ÿã€‚ */ package atomic atomic æä¾›çš„æ˜¯åŸå­æ“ä½œï¼Œatomic åŒ…ä¸­æ”¯æŒå…­ç§ç±»å‹\nint32 uint32 int64 uint64 uintptr unsafe.Pointer æ¯ä¸€ä¸ªç±»å‹éƒ½æ”¯æŒä»¥ä¸‹æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 //ä»¥Int32ç±»å‹ä¸¾ä¾‹ // SwapInt32 atomically stores new into *addr and returns the previous *addr Val. func SwapInt32(addr *int32, new int32) (old int32); // SwapInt32 atomically stores new into *addr and returns the previous *addr Val. // åŸå­æ€§çš„æ¯”è¾ƒ*addrå’Œoldï¼Œå¦‚æœç›¸åŒåˆ™å°†newèµ‹å€¼ç»™*addrå¹¶è¿”å›çœŸã€‚ func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool); // AddInt32 atomically adds delta to *addr and returns the new Val. func AddInt32(addr *int32, delta int32) (new int32); // LoadInt32 atomically loads *addr. func LoadInt32(addr *int32) (val int32); // StoreInt32 atomically stores val into *addr. func StoreInt32(addr *int32, val int32); å…¶ä¸­å¤§éƒ¨åˆ†çš„å‡½æ•°éƒ½æ˜¯ç”±æ±‡ç¼–ä»£ç å®ç°ã€‚æºç åŒ…ä¸­æ ¹æ®ç³»ç»Ÿå¹³å°çš„ä¸åŒå®ç°äº†ä¸åŒçš„.sæ±‡ç¼–ä»£ç ã€‚å…·ä½“å¯æŸ¥çœ‹/src/runtime/internal/atomicä¸‹çš„ä»£ç ï¼Œæˆ‘ä»¬ä¸¾ä¾‹ è¯´æ˜ä¸‹amd64æŒ‡ä»¤æ¶æ„ä¸‹çš„æ±‡ç¼–å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // bool Cas(int32 *val, int32 old, int32 new) // Atomically: //\tif(*val == old){ //\t*val = new; //\treturn 1; //\t} else //\treturn 0; TEXT Â·Cas(SB),NOSPLIT,$0-17 MOVQ\tptr+0(FP), BX MOVL\told+8(FP), AX MOVL\tnew+12(FP), CX LOCK CMPXCHGL\tCX, 0(BX) SETEQ\tret+16(FP) RET Caså‡½æ•°ä¸»è¦å¯¹æ¯”valåœ°å€ä¸­çš„å€¼æ˜¯å¦å’Œoldä¸€æ ·ï¼Œå¦‚æœä¸€æ ·valèµ‹å€¼newï¼Œè¿”å›trueï¼Œå¦åˆ™å®Œæˆfalseã€‚å¯¹åº”çš„æ±‡ç¼–ä»£ç è§£é‡Šå¦‚ä¸‹ï¼š è¿™æ®µä»£ç ä½¿ç”¨äº†æ±‡ç¼–è¯­è¨€æ¥è¿›è¡Œå†…å­˜æ“ä½œï¼Œä¸‹é¢æ˜¯å¯¹æ¯ä¸€è¡Œä»£ç çš„è§£é‡Šï¼š\nMOVQ ptr+0(FP), BXï¼šå°†å˜é‡ ptr åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 0 çš„ä½ç½®çš„å€¼ï¼Œå³ ptr æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œä¼ é€åˆ°å¯„å­˜å™¨ BX ä¸­ã€‚\nMOVL old+8(FP), AXï¼šå°†å˜é‡ old åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 8 çš„ä½ç½®çš„å€¼ï¼Œå³ old æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œä¼ é€åˆ°å¯„å­˜å™¨ AX ä¸­ã€‚\nMOVL new+12(FP), CXï¼šå°†å˜é‡ new åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 12 çš„ä½ç½®çš„å€¼ï¼Œå³ new æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œä¼ é€åˆ°å¯„å­˜å™¨ CX ä¸­ã€‚\nLOCKï¼šè¯¥æŒ‡ä»¤æ˜¯ä¸€ä¸ªå‰ç¼€æŒ‡ä»¤ï¼Œä½œç”¨æ˜¯åœ¨å¤šæ ¸å¿ƒå¤„ç†å™¨ä¸­ä¿è¯å¯¹å†…å­˜çš„åŸå­æ€§æ“ä½œï¼Œå³åœ¨å¯¹å†…å­˜è¿›è¡Œæ“ä½œæ—¶ï¼Œä¸ä¼šè¢«å…¶ä»–å¤„ç†å™¨çš„æ“ä½œä¸­æ–­ã€‚\nCMPXCHGL CX, 0(BX)ï¼šè¯¥æŒ‡ä»¤æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¹¶äº¤æ¢æŒ‡ä»¤ï¼Œä½œç”¨æ˜¯å°†å†…å­˜åœ°å€ BX ä¸Šçš„å€¼ä¸ AX è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å°† CX æ›¿æ¢ä¸ºå†…å­˜åœ°å€ BX ä¸Šçš„å€¼ï¼Œ å¹¶è¿”å›æˆåŠŸçš„æ ‡è®°ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œè¿”å›å¤±è´¥çš„æ ‡è®°ã€‚(å…³äºCMPXCHGLæŒ‡ä»¤çš„æ“ä½œæ•°ï¼Œå®ƒæœ‰ä¸€ä¸ªé»˜è®¤çš„æ“ä½œè€…ï¼Œå³eaxå¯„å­˜å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“CMPXCHGLæŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œ å®ƒä¼šé»˜è®¤ä½¿ç”¨eaxå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•°ï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿéœ€è¦è‡³å°‘ä¸€ä¸ªå†…å­˜åœ°å€ä½œä¸ºæ“ä½œæ•°ä¹‹ä¸€)\nSETEQ ret+16(FP)ï¼šå¦‚æœæ¯”è¾ƒå¹¶äº¤æ¢æˆåŠŸï¼Œåˆ™å°†å˜é‡ ret åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 16 çš„ä½ç½®çš„å€¼è®¾ç½®ä¸º 1ï¼ˆæ ‡è®°æˆåŠŸï¼› å¦‚æœæ¯”è¾ƒå¹¶äº¤æ¢å¤±è´¥ï¼Œåˆ™è¯¥æŒ‡ä»¤ä»€ä¹ˆä¹Ÿä¸åšï¼Œå³å˜é‡ ret çš„å€¼ä»æ—§ä¸º 0ã€‚\nRETï¼šè¿”å›å‡½æ•°å¹¶ç»“æŸæ‰§è¡Œ\nå·²ä¸Šå°±æ˜¯caså‡½æ•°çš„å®ç°è¿‡ç¨‹ã€‚æœ‰å‡ ä¸ªç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸‹ã€‚\nLOCKï¼šæ˜¯ä¸€ä¸ªæŒ‡ä»¤å‰ç¼€ï¼Œå…¶åå¿…é¡»è·Ÿä¸€æ¡â€œè¯»-æ”¹-å†™â€æ€§è´¨çš„æŒ‡ä»¤ï¼Œå®ƒä»¬å¯ä»¥æ˜¯ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B, CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, XCHGã€‚è¯¥æŒ‡ä»¤æ˜¯ä¸€ç§é”å®šåè®®ï¼Œç”¨äºå°é”æ€»çº¿ï¼Œç¦æ­¢å…¶ä»–CPUå¯¹å†…å­˜çš„æ“ä½œæ¥ä¿è¯åŸå­æ€§ã€‚\nCMPXCHGLæŒ‡ä»¤å¹¶ä¸æ˜¯ä¸ªåŸå­æŒ‡ä»¤ï¼Œåœ¨å¤šæ ¸cpuä¸‹ï¼Œè¿˜æ˜¯éœ€è¦lockè¿™ä¸ªæŒ‡ä»¤æ¥é”å®šçš„ã€‚lockä¹‹åçš„æŒ‡ä»¤ï¼Œä¼šé˜»å¡å…¶ä»–cpuçš„æŒ‡ä»¤æ‰§è¡Œã€‚å…·ä½“å®ç°æ˜¯ç‰©ç†çº§åˆ«çš„æ€»çº¿é”ï¼Œ cpuåœ¨ç¡¬ä»¶å±‚é¢æ”¯æŒåŸå­æ“ä½œã€‚ä½†æ˜¯è¿™ä¸ªé”ç²’åº¦éå¸¸å¤§ï¼Œå¾ˆå½±å“æ‰§è¡Œçš„æ•ˆç‡ã€‚æ‰€ä»¥MESIåè®®è¯ç”Ÿï¼Œå®ƒä¸»è¦æ˜¯è§£å†³å¤šæ ¸cpuæ—¶å¯¹å…±äº«æ•°æ®çš„è®¿é—®æ§åˆ¶ã€‚ å°½ç®¡æœ‰LOCKå‰ç¼€ï¼Œ ä½†å¦‚æœå¯¹åº”æ•°æ®å·²ç»åœ¨cache lineé‡Œï¼Œä¹Ÿå°±ä¸ç”¨é”å®šæ€»çº¿ï¼Œä»…é”ä½ç¼“å­˜è¡Œå³å¯ã€‚(è¿™é‡Œè¿˜æ¶‰åŠcpuç¼“å­˜çš„çŸ¥è¯†å¯ä»¥å­¦ä¹ è€—å­å“¥çš„è¿™ç¯‡æ–‡ç« ä¸ç¨‹åºå‘˜ç›¸å…³çš„CPUç¼“å­˜çŸ¥è¯†)\natomic.Val ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹atomic.Valè¿™ä¸ªå¯ä»¥å­˜å‚¨ä»»ä½•æ•°æ®çš„å‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // A Val provides an atomic load and store of a consistently typed Val. // The zero Val for a Val returns nil from Load. // Once Store has been called, a Val must not be copied. // // A Val must not be copied after first use. type Val struct { v any } // ifaceWords is interface{} internal representation. type ifaceWords struct { typ unsafe.Pointer data unsafe.Pointer } Valç»“æ„å°±æ˜¯ä¸ªinterfaceç±»å‹ï¼Œå®é™…çš„æ•°æ®å­˜å‚¨æ˜¯ifaceWordsç±»å‹ã€‚typæŒ‡é’ˆä¿å­˜å­˜å‚¨å¯¹è±¡çš„ç±»å‹ã€‚dataæŒ‡é’ˆå°±æ˜¯å®é™…çš„æ•°æ®ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹Loadå’ŒStoreæ–¹æ³•çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func (v *Val) Store(x interface{}) { // xä¸ºnilï¼Œç›´æ¥panic if x == nil { panic(\"sync/atomic: store of nil Val into Val\") } // å°†ç°æœ‰çš„å€¼å’Œè¦å†™å…¥çš„å€¼è½¬æ¢ä¸ºifaceWordsç±»å‹ï¼Œè¿™æ ·ä¸‹ä¸€æ­¥å°±èƒ½è·å–åˆ°å®ƒä»¬çš„åŸå§‹ç±»å‹å’ŒçœŸæ­£çš„å€¼ vp := (*ifaceWords)(unsafe.Pointer(v)) xp := (*ifaceWords)(unsafe.Pointer(\u0026x)) for { // è·å–ç°æœ‰çš„å€¼çš„type typ := LoadPointer(\u0026vp.typ) // å¦‚æœtypä¸ºnilè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨Store if typ == nil { // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå°±å ä½å½“å‰çš„processorï¼Œä¸å…è®¸å…¶ä»–goroutineå†æŠ¢ï¼Œ // runtime_procPinæ–¹æ³•ä¼šå…ˆè·å–å½“å‰goroutine runtime_procPin() // ä½¿ç”¨CASæ“ä½œï¼Œå…ˆå°è¯•å°†typè®¾ç½®ä¸º^uintptr(0)è¿™ä¸ªä¸­é—´çŠ¶æ€ // å¦‚æœå¤±è´¥ï¼Œåˆ™è¯æ˜å·²ç»æœ‰åˆ«çš„goroutineæŠ¢å…ˆå®Œæˆäº†èµ‹å€¼æ“ä½œ // é‚£å®ƒå°±è§£é™¤æŠ¢å é”ï¼Œç»§ç»­å¾ªç¯ç­‰å¾… if !CompareAndSwapPointer(\u0026vp.typ, nil, unsafe.Pointer(^uintptr(0))) { runtime_procUnpin() continue } // å¦‚æœè®¾ç½®æˆåŠŸï¼Œå°±åŸå­æ€§çš„æ›´æ–°å¯¹åº”çš„æŒ‡é’ˆï¼Œæœ€åè§£é™¤æŠ¢å é” StorePointer(\u0026vp.data, xp.data) StorePointer(\u0026vp.typ, xp.typ) runtime_procUnpin() return } // å¦‚æœtypä¸º^uintptr(0)è¯´æ˜ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æ²¡æœ‰å®Œæˆï¼Œç»§ç»­å¾ªç¯ç­‰å¾… if uintptr(typ) == ^uintptr(0) { continue } // å¦‚æœè¦å†™å…¥çš„ç±»å‹å’Œç°æœ‰çš„ç±»å‹ä¸ä¸€è‡´ï¼Œåˆ™panic if typ != xp.typ { panic(\"sync/atomic: store of inconsistently typed Val into Val\") } // æ›´æ–°dataï¼Œè·³å‡ºå¾ªç¯ StorePointer(\u0026vp.data, xp.data) return } } ä¸Šé¢ä»£ç è®²è§£çš„éå¸¸æ¸…æ™°ï¼Œç®€å•æ¥è¯´ï¼Œæ‰€è°“çš„atomic.Valå°±åƒæ˜¯interfaceä¸€æ ·ï¼Œå­˜å‚¨å¯¹è±¡çš„ç±»å‹å’Œæ•°æ®ã€‚ç„¶åé€šè¿‡æŒ‡é’ˆï¼Œèµ‹å€¼æ“ä½œç®¡ç†å¯¹è±¡ã€‚ä¸Šé¢ä»£ç ä¸­æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼š\nruntime_procPinã€runtime_procUnpinå‡½æ•° åœ¨ Golang çš„è¿è¡Œæ—¶ä¸­ï¼Œæ¯ä¸ª goroutine éƒ½æ˜¯ä»å¯ç”¨çš„é€»è¾‘å¤„ç†å™¨ä¸­è·å–æ‰§è¡Œèµ„æºï¼Œå®ƒèƒ½å¤Ÿéšæ—¶åœ¨è¿™äº›é€»è¾‘å¤„ç†å™¨ä¹‹é—´åˆ‡æ¢ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªç‰¹å®šçš„ goroutine å›ºå®šåœ¨æŒ‡å®šçš„å½“å‰çº¿ç¨‹ä¸Š(M)è¿è¡Œï¼Œè€Œ runtime_procPin å‡½æ•°å°±æ˜¯ä¸ºäº†å®ç°è¿™ä¸€åŠŸèƒ½è€Œè®¾è®¡çš„ã€‚å…·ä½“å®ç°æ—¶ï¼Œ runtime_procPin å‡½æ•°ä¼šå°†å½“å‰ goroutine ç»‘å®šåˆ°æŒ‡å®šçš„çº¿ç¨‹ä¸Šï¼Œå¹¶å°†è¯¥çº¿ç¨‹ç½®äºå›ºå®šè°ƒåº¦æ¨¡å¼ä¸‹ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æŒ‡å®šçš„çº¿ç¨‹ä¸€ç›´è¢«ç”¨äºæ‰§è¡Œè¯¥goroutineï¼Œ è€Œä¸ä¼šè¢«å…¶ä»– goroutine æŠ¢å ã€‚åœ¨è¿è¡Œå®Œæˆåï¼Œä½¿ç”¨ runtime_procUnpin å‡½æ•°è§£é™¤ç»‘å®šã€‚\nunsafe.Pointer(^uintptr(0))åªæ˜¯ä¸ªä¸­é—´çŠ¶æ€ï¼Œå¹¶å‘storeæ—¶ï¼Œç”¨æ¥åˆ¤æ–­åˆå§‹åŒ–å†™å…¥æ˜¯å¦å®Œæˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (v *Val) Load() (x interface{}) { // å°†*ValæŒ‡é’ˆç±»å‹è½¬æ¢ä¸º*ifaceWordsæŒ‡é’ˆç±»å‹ vp := (*ifaceWords)(unsafe.Pointer(v)) // åŸå­æ€§çš„è·å–åˆ°vçš„ç±»å‹typçš„æŒ‡é’ˆ typ := LoadPointer(\u0026vp.typ) // å¦‚æœæ²¡æœ‰å†™å…¥æˆ–è€…æ­£åœ¨å†™å…¥ï¼Œå…ˆè¿”å›ï¼Œ^uintptr(0)ä»£è¡¨è¿‡æ¸¡çŠ¶æ€ï¼Œè¿™å’ŒStoreæ˜¯å¯¹åº”çš„ if typ == nil || uintptr(typ) == ^uintptr(0) { return nil } // åŸå­æ€§çš„è·å–åˆ°vçš„çœŸæ­£çš„å€¼dataçš„æŒ‡é’ˆï¼Œç„¶åè¿”å› data := LoadPointer(\u0026vp.data) xp := (*ifaceWords)(unsafe.Pointer(\u0026x)) xp.typ = typ xp.data = data return } Loadä»£ç å°±æ¯”è¾ƒç®€å•äº†ï¼Œå¯¹æ¯”Storeç›¸ä¿¡ä½ è‚¯å®šèƒ½å®Œå…¨ç†è§£ã€‚\nå‚è€ƒ https://learnku.com/docs/learngo/1.0/atomic/14038 https://zhuanlan.zhihu.com/p/343563035 https://www.cyub.vip/2021/04/05/Golang%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E4%B9%8Batomic%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/ https://blog.csdn.net/lotluck/article/details/78793468 https://coolshell.cn/articles/20793.html ",
  "wordCount" : "3038",
  "inLanguage": "en",
  "datePublished": "2023-03-13T16:40:32+08:00",
  "dateModified": "2023-03-13T16:40:32+08:00",
  "author":[{
    "@type": "Person",
    "name": "Younger"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://younger027.github.io/en/posts/tech/go-atomic/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Younger's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://youngergo.cn/images/life/me/avatar.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://younger027.github.io/en/" accesskey="h" title="Younger&#39;s Blog (Alt + H)">
                <img src="https://youngergo.cn/images/life/me/avatar.jpg" alt="" aria-label="logo"
                    height="35">Younger&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://younger027.github.io/en/">Home</a>&nbsp;Â»&nbsp;<a href="https://younger027.github.io/en/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://younger027.github.io/en/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Go Atomic
    </h1>
    <div class="post-meta"><span title='2023-03-13 16:40:32 +0800 CST'>2023-03-13</span>&nbsp;Â·&nbsp;7 min&nbsp;Â·&nbsp;Younger

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90" aria-label="æºç è§£æ">æºç è§£æ</a></li>
                <li>
                    <a href="#atomicval" aria-label="atomic.Val">atomic.Val</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="æºç è§£æ">æºç è§£æ<a hidden class="anchor" aria-hidden="true" href="#æºç è§£æ">#</a></h3>
<p>æºç ç‰ˆæœ¬ï¼š1.18</p>
<p>atomicåŒ…ä¸»è¦æ”¯æŒä¸€äº›åŸå­æ“ä½œï¼Œé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹æºç docæ–‡ä»¶(atomicçš„æºç è·¯å¾„ï¼š/src/runtime/internal/atomic)å¯¹atomicçš„ä»‹ç»ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Package atomic provides atomic operations, independent of sync/atomic,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">to the runtime.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">On most platforms, the compiler is aware of the functions defined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">in this package, and they&#39;re replaced with platform-specific intrinsics.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">On other platforms, generic implementations are made available.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Unless otherwise noted, operations defined in this package are sequentially
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">consistent across threads with respect to the Vals they manipulate. More
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">specifically, operations that happen in a specific order on one thread,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">will always be observed to happen in exactly that order by another thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">åŒ…atomicæä¾›åŸå­æ“ä½œï¼Œç‹¬ç«‹äºsync/atomicã€‚å‘è¿è¡Œæ—¶æä¾›åŸå­æ“ä½œã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œç¼–è¯‘å™¨éƒ½çŸ¥é“è¿™ä¸ªåŒ…ä¸­å®šä¹‰çš„å‡½æ•°ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">åœ¨è¿™ä¸ªåŒ…ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œå®ƒä»¬è¢«æ›¿æ¢æˆç‰¹å®šå¹³å°çš„æœ¬å¾ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">åœ¨å…¶ä»–å¹³å°ä¸Šï¼Œé€šç”¨çš„å®ç°æ˜¯å¯ç”¨çš„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">é™¤éå¦æœ‰è¯´æ˜ï¼Œæœ¬åŒ…ä¸­å®šä¹‰çš„æ“ä½œåœ¨é¡ºåºä¸Šæ˜¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">åœ¨å®ƒä»¬æ‰€æ“ä½œçš„å€¼æ–¹é¢ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ˜¯ä¸€è‡´çš„ã€‚æ›´å…·ä½“åœ°è¯´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">å…·ä½“æ¥è¯´ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šä»¥ç‰¹å®šé¡ºåºå‘ç”Ÿçš„æ“ä½œã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">å°†æ€»æ˜¯è¢«å¦ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿåˆ°ä»¥è¯¥é¡ºåºå‘ç”Ÿã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">atomic</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>atomic æä¾›çš„æ˜¯åŸå­æ“ä½œï¼Œatomic åŒ…ä¸­æ”¯æŒå…­ç§ç±»å‹</p>
<ul>
<li>int32</li>
<li>uint32</li>
<li>int64</li>
<li>uint64</li>
<li>uintptr</li>
<li>unsafe.Pointer</li>
</ul>
<p>æ¯ä¸€ä¸ªç±»å‹éƒ½æ”¯æŒä»¥ä¸‹æ“ä½œï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//ä»¥Int32ç±»å‹ä¸¾ä¾‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SwapInt32 atomically stores new into *addr and returns the previous *addr Val.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SwapInt32</span>(<span style="color:#a6e22e">addr</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int32</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">int32</span>) (<span style="color:#a6e22e">old</span> <span style="color:#66d9ef">int32</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SwapInt32 atomically stores new into *addr and returns the previous *addr Val.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// åŸå­æ€§çš„æ¯”è¾ƒ*addrå’Œoldï¼Œå¦‚æœç›¸åŒåˆ™å°†newèµ‹å€¼ç»™*addrå¹¶è¿”å›çœŸã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CompareAndSwapInt32</span>(<span style="color:#a6e22e">addr</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int32</span>, <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">int32</span>) (<span style="color:#a6e22e">swapped</span> <span style="color:#66d9ef">bool</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AddInt32 atomically adds delta to *addr and returns the new Val.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AddInt32</span>(<span style="color:#a6e22e">addr</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int32</span>, <span style="color:#a6e22e">delta</span> <span style="color:#66d9ef">int32</span>) (<span style="color:#a6e22e">new</span> <span style="color:#66d9ef">int32</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// LoadInt32 atomically loads *addr.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoadInt32</span>(<span style="color:#a6e22e">addr</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int32</span>) (<span style="color:#a6e22e">val</span> <span style="color:#66d9ef">int32</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// StoreInt32 atomically stores val into *addr.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">StoreInt32</span>(<span style="color:#a6e22e">addr</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int32</span>, <span style="color:#a6e22e">val</span> <span style="color:#66d9ef">int32</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­å¤§éƒ¨åˆ†çš„å‡½æ•°éƒ½æ˜¯ç”±æ±‡ç¼–ä»£ç å®ç°ã€‚æºç åŒ…ä¸­æ ¹æ®ç³»ç»Ÿå¹³å°çš„ä¸åŒå®ç°äº†ä¸åŒçš„.sæ±‡ç¼–ä»£ç ã€‚å…·ä½“å¯æŸ¥çœ‹/src/runtime/internal/atomicä¸‹çš„ä»£ç ï¼Œæˆ‘ä»¬ä¸¾ä¾‹
è¯´æ˜ä¸‹amd64æŒ‡ä»¤æ¶æ„ä¸‹çš„æ±‡ç¼–å®ç°ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// bool Cas(int32 *val, int32 old, int32 new)
</span></span><span style="display:flex;"><span>// Atomically:
</span></span><span style="display:flex;"><span>//	if(*val == old){
</span></span><span style="display:flex;"><span>//		*val = new;
</span></span><span style="display:flex;"><span>//		return 1;
</span></span><span style="display:flex;"><span>//	} else
</span></span><span style="display:flex;"><span>//		return 0;
</span></span><span style="display:flex;"><span>TEXT Â·Cas(SB),NOSPLIT,$0-17
</span></span><span style="display:flex;"><span>	MOVQ	ptr+0(FP), BX
</span></span><span style="display:flex;"><span>	MOVL	old+8(FP), AX
</span></span><span style="display:flex;"><span>	MOVL	new+12(FP), CX
</span></span><span style="display:flex;"><span>	LOCK
</span></span><span style="display:flex;"><span>	CMPXCHGL	CX, 0(BX)
</span></span><span style="display:flex;"><span>	SETEQ	ret+16(FP)
</span></span><span style="display:flex;"><span>	RET
</span></span></code></pre></td></tr></table>
</div>
</div><p>Caså‡½æ•°ä¸»è¦å¯¹æ¯”valåœ°å€ä¸­çš„å€¼æ˜¯å¦å’Œoldä¸€æ ·ï¼Œå¦‚æœä¸€æ ·valèµ‹å€¼newï¼Œè¿”å›trueï¼Œå¦åˆ™å®Œæˆfalseã€‚å¯¹åº”çš„æ±‡ç¼–ä»£ç è§£é‡Šå¦‚ä¸‹ï¼š
è¿™æ®µä»£ç ä½¿ç”¨äº†æ±‡ç¼–è¯­è¨€æ¥è¿›è¡Œå†…å­˜æ“ä½œï¼Œä¸‹é¢æ˜¯å¯¹æ¯ä¸€è¡Œä»£ç çš„è§£é‡Šï¼š</p>
<ol>
<li>
<p>MOVQ ptr+0(FP), BXï¼šå°†å˜é‡ ptr åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 0 çš„ä½ç½®çš„å€¼ï¼Œå³ ptr æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œä¼ é€åˆ°å¯„å­˜å™¨ BX ä¸­ã€‚</p>
</li>
<li>
<p>MOVL old+8(FP), AXï¼šå°†å˜é‡ old åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 8 çš„ä½ç½®çš„å€¼ï¼Œå³ old æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œä¼ é€åˆ°å¯„å­˜å™¨ AX ä¸­ã€‚</p>
</li>
<li>
<p>MOVL new+12(FP), CXï¼šå°†å˜é‡ new åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 12 çš„ä½ç½®çš„å€¼ï¼Œå³ new æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œä¼ é€åˆ°å¯„å­˜å™¨ CX ä¸­ã€‚</p>
</li>
<li>
<p>LOCKï¼šè¯¥æŒ‡ä»¤æ˜¯ä¸€ä¸ªå‰ç¼€æŒ‡ä»¤ï¼Œä½œç”¨æ˜¯åœ¨å¤šæ ¸å¿ƒå¤„ç†å™¨ä¸­ä¿è¯å¯¹å†…å­˜çš„åŸå­æ€§æ“ä½œï¼Œå³åœ¨å¯¹å†…å­˜è¿›è¡Œæ“ä½œæ—¶ï¼Œä¸ä¼šè¢«å…¶ä»–å¤„ç†å™¨çš„æ“ä½œä¸­æ–­ã€‚</p>
</li>
<li>
<p>CMPXCHGL CX, 0(BX)ï¼šè¯¥æŒ‡ä»¤æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¹¶äº¤æ¢æŒ‡ä»¤ï¼Œä½œç”¨æ˜¯å°†å†…å­˜åœ°å€ BX ä¸Šçš„å€¼ä¸ AX è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å°† CX æ›¿æ¢ä¸ºå†…å­˜åœ°å€ BX ä¸Šçš„å€¼ï¼Œ
å¹¶è¿”å›æˆåŠŸçš„æ ‡è®°ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œè¿”å›å¤±è´¥çš„æ ‡è®°ã€‚(å…³äºCMPXCHGLæŒ‡ä»¤çš„æ“ä½œæ•°ï¼Œå®ƒæœ‰ä¸€ä¸ªé»˜è®¤çš„æ“ä½œè€…ï¼Œå³eaxå¯„å­˜å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“CMPXCHGLæŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œ
å®ƒä¼šé»˜è®¤ä½¿ç”¨eaxå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•°ï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿéœ€è¦è‡³å°‘ä¸€ä¸ªå†…å­˜åœ°å€ä½œä¸ºæ“ä½œæ•°ä¹‹ä¸€)</p>
</li>
<li>
<p>SETEQ ret+16(FP)ï¼šå¦‚æœæ¯”è¾ƒå¹¶äº¤æ¢æˆåŠŸï¼Œåˆ™å°†å˜é‡ ret åœ¨å¸§æŒ‡é’ˆ FP ä¸Šçš„åç§»é‡ä¸º 16 çš„ä½ç½®çš„å€¼è®¾ç½®ä¸º 1ï¼ˆæ ‡è®°æˆåŠŸï¼›
å¦‚æœæ¯”è¾ƒå¹¶äº¤æ¢å¤±è´¥ï¼Œåˆ™è¯¥æŒ‡ä»¤ä»€ä¹ˆä¹Ÿä¸åšï¼Œå³å˜é‡ ret çš„å€¼ä»æ—§ä¸º 0ã€‚</p>
</li>
<li>
<p>RETï¼šè¿”å›å‡½æ•°å¹¶ç»“æŸæ‰§è¡Œ</p>
</li>
</ol>
<p>å·²ä¸Šå°±æ˜¯caså‡½æ•°çš„å®ç°è¿‡ç¨‹ã€‚æœ‰å‡ ä¸ªç‚¹æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸‹ã€‚</p>
<ol>
<li>
<p>LOCKï¼šæ˜¯ä¸€ä¸ªæŒ‡ä»¤å‰ç¼€ï¼Œå…¶åå¿…é¡»è·Ÿä¸€æ¡â€œè¯»-æ”¹-å†™â€æ€§è´¨çš„æŒ‡ä»¤ï¼Œå®ƒä»¬å¯ä»¥æ˜¯ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B, CMPXCHG16B,
DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, XCHGã€‚è¯¥æŒ‡ä»¤æ˜¯ä¸€ç§é”å®šåè®®ï¼Œç”¨äºå°é”æ€»çº¿ï¼Œç¦æ­¢å…¶ä»–CPUå¯¹å†…å­˜çš„æ“ä½œæ¥ä¿è¯åŸå­æ€§ã€‚</p>
</li>
<li>
<p>CMPXCHGLæŒ‡ä»¤å¹¶ä¸æ˜¯ä¸ªåŸå­æŒ‡ä»¤ï¼Œåœ¨å¤šæ ¸cpuä¸‹ï¼Œè¿˜æ˜¯éœ€è¦lockè¿™ä¸ªæŒ‡ä»¤æ¥é”å®šçš„ã€‚lockä¹‹åçš„æŒ‡ä»¤ï¼Œä¼šé˜»å¡å…¶ä»–cpuçš„æŒ‡ä»¤æ‰§è¡Œã€‚å…·ä½“å®ç°æ˜¯ç‰©ç†çº§åˆ«çš„æ€»çº¿é”ï¼Œ
cpuåœ¨ç¡¬ä»¶å±‚é¢æ”¯æŒåŸå­æ“ä½œã€‚ä½†æ˜¯è¿™ä¸ªé”ç²’åº¦éå¸¸å¤§ï¼Œå¾ˆå½±å“æ‰§è¡Œçš„æ•ˆç‡ã€‚æ‰€ä»¥MESIåè®®è¯ç”Ÿï¼Œå®ƒä¸»è¦æ˜¯è§£å†³å¤šæ ¸cpuæ—¶å¯¹å…±äº«æ•°æ®çš„è®¿é—®æ§åˆ¶ã€‚ å°½ç®¡æœ‰LOCKå‰ç¼€ï¼Œ
ä½†å¦‚æœå¯¹åº”æ•°æ®å·²ç»åœ¨cache lineé‡Œï¼Œä¹Ÿå°±ä¸ç”¨é”å®šæ€»çº¿ï¼Œä»…é”ä½ç¼“å­˜è¡Œå³å¯ã€‚(è¿™é‡Œè¿˜æ¶‰åŠcpuç¼“å­˜çš„çŸ¥è¯†å¯ä»¥å­¦ä¹ è€—å­å“¥çš„è¿™ç¯‡æ–‡ç« <a href="https://coolshell.cn/articles/20793.html">ä¸ç¨‹åºå‘˜ç›¸å…³çš„CPUç¼“å­˜çŸ¥è¯†</a>)</p>
</li>
</ol>
<h3 id="atomicval">atomic.Val<a hidden class="anchor" aria-hidden="true" href="#atomicval">#</a></h3>
<p>ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹atomic.Valè¿™ä¸ªå¯ä»¥å­˜å‚¨ä»»ä½•æ•°æ®çš„å‡½æ•°ã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// A Val provides an atomic load and store of a consistently typed Val.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// The zero Val for a Val returns nil from Load.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Once Store has been called, a Val must not be copied.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// A Val must not be copied after first use.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Val</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span> <span style="color:#a6e22e">any</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ifaceWords is interface{} internal representation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ifaceWords</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">typ</span>  <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Valç»“æ„å°±æ˜¯ä¸ªinterfaceç±»å‹ï¼Œå®é™…çš„æ•°æ®å­˜å‚¨æ˜¯ifaceWordsç±»å‹ã€‚typæŒ‡é’ˆä¿å­˜å­˜å‚¨å¯¹è±¡çš„ç±»å‹ã€‚dataæŒ‡é’ˆå°±æ˜¯å®é™…çš„æ•°æ®ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹Loadå’ŒStoreæ–¹æ³•çš„å®ç°ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Val</span>) <span style="color:#a6e22e">Store</span>(<span style="color:#a6e22e">x</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// xä¸ºnilï¼Œç›´æ¥panic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        panic(<span style="color:#e6db74">&#34;sync/atomic: store of nil Val into Val&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†ç°æœ‰çš„å€¼å’Œè¦å†™å…¥çš„å€¼è½¬æ¢ä¸ºifaceWordsç±»å‹ï¼Œè¿™æ ·ä¸‹ä¸€æ­¥å°±èƒ½è·å–åˆ°å®ƒä»¬çš„åŸå§‹ç±»å‹å’ŒçœŸæ­£çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">vp</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">ifaceWords</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">v</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xp</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">ifaceWords</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è·å–ç°æœ‰çš„å€¼çš„type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">typ</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">vp</span>.<span style="color:#a6e22e">typ</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¦‚æœtypä¸ºnilè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨Store
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">typ</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå°±å ä½å½“å‰çš„processorï¼Œä¸å…è®¸å…¶ä»–goroutineå†æŠ¢ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// runtime_procPinæ–¹æ³•ä¼šå…ˆè·å–å½“å‰goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">runtime_procPin</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ä½¿ç”¨CASæ“ä½œï¼Œå…ˆå°è¯•å°†typè®¾ç½®ä¸º^uintptr(0)è¿™ä¸ªä¸­é—´çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// å¦‚æœå¤±è´¥ï¼Œåˆ™è¯æ˜å·²ç»æœ‰åˆ«çš„goroutineæŠ¢å…ˆå®Œæˆäº†èµ‹å€¼æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// é‚£å®ƒå°±è§£é™¤æŠ¢å é”ï¼Œç»§ç»­å¾ªç¯ç­‰å¾…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">CompareAndSwapPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">vp</span>.<span style="color:#a6e22e">typ</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(^uintptr(<span style="color:#ae81ff">0</span>))) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">runtime_procUnpin</span>()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// å¦‚æœè®¾ç½®æˆåŠŸï¼Œå°±åŸå­æ€§çš„æ›´æ–°å¯¹åº”çš„æŒ‡é’ˆï¼Œæœ€åè§£é™¤æŠ¢å é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">StorePointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">vp</span>.<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">xp</span>.<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">StorePointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">vp</span>.<span style="color:#a6e22e">typ</span>, <span style="color:#a6e22e">xp</span>.<span style="color:#a6e22e">typ</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">runtime_procUnpin</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¦‚æœtypä¸º^uintptr(0)è¯´æ˜ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æ²¡æœ‰å®Œæˆï¼Œç»§ç»­å¾ªç¯ç­‰å¾…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> uintptr(<span style="color:#a6e22e">typ</span>) <span style="color:#f92672">==</span> ^uintptr(<span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¦‚æœè¦å†™å…¥çš„ç±»å‹å’Œç°æœ‰çš„ç±»å‹ä¸ä¸€è‡´ï¼Œåˆ™panic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">typ</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">xp</span>.<span style="color:#a6e22e">typ</span> {
</span></span><span style="display:flex;"><span>            panic(<span style="color:#e6db74">&#34;sync/atomic: store of inconsistently typed Val into Val&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// æ›´æ–°dataï¼Œè·³å‡ºå¾ªç¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">StorePointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">vp</span>.<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">xp</span>.<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ä»£ç è®²è§£çš„éå¸¸æ¸…æ™°ï¼Œç®€å•æ¥è¯´ï¼Œæ‰€è°“çš„atomic.Valå°±åƒæ˜¯interfaceä¸€æ ·ï¼Œå­˜å‚¨å¯¹è±¡çš„ç±»å‹å’Œæ•°æ®ã€‚ç„¶åé€šè¿‡æŒ‡é’ˆï¼Œèµ‹å€¼æ“ä½œç®¡ç†å¯¹è±¡ã€‚ä¸Šé¢ä»£ç ä¸­æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li>
<p>runtime_procPinã€runtime_procUnpinå‡½æ•°
åœ¨ Golang çš„è¿è¡Œæ—¶ä¸­ï¼Œæ¯ä¸ª goroutine éƒ½æ˜¯ä»å¯ç”¨çš„é€»è¾‘å¤„ç†å™¨ä¸­è·å–æ‰§è¡Œèµ„æºï¼Œå®ƒèƒ½å¤Ÿéšæ—¶åœ¨è¿™äº›é€»è¾‘å¤„ç†å™¨ä¹‹é—´åˆ‡æ¢ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ
æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªç‰¹å®šçš„ goroutine å›ºå®šåœ¨æŒ‡å®šçš„å½“å‰çº¿ç¨‹ä¸Š(M)è¿è¡Œï¼Œè€Œ runtime_procPin å‡½æ•°å°±æ˜¯ä¸ºäº†å®ç°è¿™ä¸€åŠŸèƒ½è€Œè®¾è®¡çš„ã€‚å…·ä½“å®ç°æ—¶ï¼Œ
runtime_procPin å‡½æ•°ä¼šå°†å½“å‰ goroutine ç»‘å®šåˆ°æŒ‡å®šçš„çº¿ç¨‹ä¸Šï¼Œå¹¶å°†è¯¥çº¿ç¨‹ç½®äºå›ºå®šè°ƒåº¦æ¨¡å¼ä¸‹ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æŒ‡å®šçš„çº¿ç¨‹ä¸€ç›´è¢«ç”¨äºæ‰§è¡Œè¯¥goroutineï¼Œ
è€Œä¸ä¼šè¢«å…¶ä»– goroutine æŠ¢å ã€‚åœ¨è¿è¡Œå®Œæˆåï¼Œä½¿ç”¨ runtime_procUnpin å‡½æ•°è§£é™¤ç»‘å®šã€‚</p>
</li>
<li>
<p>unsafe.Pointer(^uintptr(0))åªæ˜¯ä¸ªä¸­é—´çŠ¶æ€ï¼Œå¹¶å‘storeæ—¶ï¼Œç”¨æ¥åˆ¤æ–­åˆå§‹åŒ–å†™å…¥æ˜¯å¦å®Œæˆã€‚</p>
</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Val</span>) <span style="color:#a6e22e">Load</span>() (<span style="color:#a6e22e">x</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å°†*ValæŒ‡é’ˆç±»å‹è½¬æ¢ä¸º*ifaceWordsæŒ‡é’ˆç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">vp</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">ifaceWords</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">v</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åŸå­æ€§çš„è·å–åˆ°vçš„ç±»å‹typçš„æŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">typ</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">vp</span>.<span style="color:#a6e22e">typ</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœæ²¡æœ‰å†™å…¥æˆ–è€…æ­£åœ¨å†™å…¥ï¼Œå…ˆè¿”å›ï¼Œ^uintptr(0)ä»£è¡¨è¿‡æ¸¡çŠ¶æ€ï¼Œè¿™å’ŒStoreæ˜¯å¯¹åº”çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">typ</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> uintptr(<span style="color:#a6e22e">typ</span>) <span style="color:#f92672">==</span> ^uintptr(<span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åŸå­æ€§çš„è·å–åˆ°vçš„çœŸæ­£çš„å€¼dataçš„æŒ‡é’ˆï¼Œç„¶åè¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">LoadPointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">vp</span>.<span style="color:#a6e22e">data</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xp</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">ifaceWords</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xp</span>.<span style="color:#a6e22e">typ</span> = <span style="color:#a6e22e">typ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xp</span>.<span style="color:#a6e22e">data</span> = <span style="color:#a6e22e">data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Loadä»£ç å°±æ¯”è¾ƒç®€å•äº†ï¼Œå¯¹æ¯”Storeç›¸ä¿¡ä½ è‚¯å®šèƒ½å®Œå…¨ç†è§£ã€‚</p>
<h3 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h3>
<ul>
<li><a href="https://learnku.com/docs/learngo/1.0/atomic/14038">https://learnku.com/docs/learngo/1.0/atomic/14038</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/343563035">https://zhuanlan.zhihu.com/p/343563035</a></li>
<li><a href="https://www.cyub.vip/2021/04/05/Golang%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E4%B9%8Batomic%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/">https://www.cyub.vip/2021/04/05/Golang%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E4%B9%8Batomic%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/</a></li>
<li><a href="https://blog.csdn.net/lotluck/article/details/78793468">https://blog.csdn.net/lotluck/article/details/78793468</a></li>
<li><a href="https://coolshell.cn/articles/20793.html">https://coolshell.cn/articles/20793.html</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://younger027.github.io/en/tags/golang/">golang</a></li>
      <li><a href="https://younger027.github.io/en/tags/%E6%BA%90%E7%A0%81/">æºç </a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://younger027.github.io/en/posts/tech/go-ants/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Go Ants</span>
  </a>
  <a class="next" href="https://younger027.github.io/en/posts/tech/go-chan/">
    <span class="title">Next Â»</span>
    <br>
    <span>Go Chan</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://younger027.github.io/en/">Younger&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
